<!DOCTYPE html>
<html lang="en">
<head>
<base href="/">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CloudApp Editor</title>
<script src="https://nkmplay.github.io/cgf/scripts/fabric.min.js"></script>
    <script src="https://nkmplay.github.io/cgf/scripts/html2canvas.min.js"></script>
    <script src="https://nkmplay.github.io/cgf/scripts/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://nkmplay.github.io/cgf/scripts/pdf.worker.min.js';</script>
    <link rel="stylesheet" href="https://nkmplay.github.io/cgf/scripts/cropper.min.css">
    <script src="https://nkmplay.github.io/cgf/scripts/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.4.0/dist/pdf-lib.min.js"></script>
	<script src="https://cloudgraficaweb.github.io/CGVendas/scripts/potrace.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.0/dist/svg.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body,html{margin:0;padding:0;height:100%;overflow:hidden;font-family:Arial,sans-serif}
  #left-menu{position:fixed;top:40px;left:0;width:70px;bottom:0;background-color:#0f3460;padding:10px;color:#fff}
  #canvas-container{position:fixed;top:40px;left:80px;right:200px;bottom:0;background-color:transparent;overflow:hidden}
  .tool-button {
    background-color:#0f3460;
    color:#fff;
    border:2px solid #4a90e2;
    padding:8px 8px;
    border-radius:4px;
    width:100%;
    cursor:pointer;
    font-size:9px;
    font-weight:700;
    height:50px;
    margin:5px 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:10px;
  }
  .tool-button i {
    font-size:12px;
  }
  .tool-button .shortcut {
    color: #4a90e2;
    font-size: 0.8em;
    margin-left: auto;
    padding-left: 10px;
    opacity: 0.8;
}
  .tool-button.selected {
    background-color: #4a90e2;
  }
  .separator {
    border-bottom: 0px solid #4a90e2;
    margin: 10px 0;
  }
  #fileInput{display:none}
  #top-menu{position:fixed;top:0;left:0;right:0;height:40px;background-color:#0f3460;display:flex;align-items:center;padding:0 5px;z-index:1000}
  .menu-item{position:relative;color:#fff;padding:0 12px;cursor:pointer;height:100%;display:flex;align-items:center}
  .menu-item:hover .dropdown{display:block}
  .dropdown{display:none;position:absolute;top:40px;left:0;background-color:#0f3460;min-width:250px;box-shadow:0 12px 24px rgba(0,0,0,0.4), 0 4px 8px rgba(0,0,0,0.3)}
  .dropdown a{color:#fff;padding:12px 16px;text-decoration:none;display:block;display:flex;justify-content:space-between;align-items:center}
  
  .dropdown a {
    display: flex;
    align-items: center;
    justify-content: space-between; 
    gap: 10px;
}
  
  .dropdown input{width:60px;padding:2px 4px;margin-left:10px;border-radius:3px;border:1px solid #ccc}

  .size-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 20px;
    color: white;
  }
  .size-controls input {
    width: 60px;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
  }
  .size-controls button {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    padding: 4px 8px;
    font-size: 16px;
  }
  .thick-separator {
    border-left: 2px solid #4a90e2;
    height: 24px;
    margin: 0 10px;
  }
  .document-size-item {
    position: relative;
  }

  .document-size-controls {
    position: absolute;
    left: 100%;
    top: 0;
    background-color: #0f3460;
    padding: 12px;
    border-radius: 4px;
    display: none;
    gap: 8px;
    min-width: 200px;
  }

  .document-size-item:hover .document-size-controls {
    display: flex;
    flex-direction: column;
  }

  .size-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .document-size-controls input {
    width: 60px;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
  }

  .document-size-controls button {
    background: none;
    border: 1px solid #4a90e2;
    color: white;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
  }

  .document-size-controls #doc-size-ok {
    background: #4a90e2;
    width: 100%;
    margin-top: 8px;
  }

  .guides-item {
    position: relative;
  }

  .guides-controls {
    position: absolute;
    left: 100%;
    top: 0;
    background-color: #0f3460;
    padding: 12px;
    border-radius: 4px;
    display: none;
    gap: 8px;
    min-width: 200px;
  }

  .guides-item:hover .guides-controls {
    display: flex;
    flex-direction: column;
  }

  .guide-options {
    display: flex;
    gap: 4px;
  }

  .guide-btn {
    flex: 1;
    background: #16213e;
    border: 1px solid #4a90e2;
    color: white;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
  }

  .guide-btn.selected {
    background: #4a90e2;
  }

  .guide-position {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .guide-position input {
    width: 100%;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
  }

  #right-menu {
    position: fixed;
    top: 40px;
    right: 0;
    width: 200px;
    bottom: 0;
    background-color: #0f3460;
    color: #fff;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  #layersList {
    list-style: none;
    padding: 0;
    margin: 0 0 10px 0;
    flex-grow: 1;
    overflow-y: auto;
  }

  #layersList li {
    padding: 8px 12px;
    cursor: pointer;
    background: #16213e;
    margin-bottom: 4px;
    border-radius: 4px;
    user-select: none;
    display: flex;
    align-items: center;
    color: #fff;
    transition: background-color 0.2s;
  }

  #layersList li.selected {
    background: #4a90e2;
    color: #ffeb3b;
  }

  #layersList li.dragging {
    opacity: 0.5;
  }

  #layersList li.over {
    border: 2px dashed #4a90e2;
  }

  .layers-buttons {
    position: sticky;
    bottom: 0;
    background: #0f3460;
    padding-top: 10px;
    display: flex;
    gap: 5px;
  }

  .layer-btn {
    flex: 1;
    background: #16213e;
    border: 1px solid #4a90e2;
    color: white;
    padding: 8px;
    border-radius: 4px;
    cursor: pointer;
  }

  .layer-btn:hover {
    background: #4a90e2;
  }
  .thick-separator {
    border-left: 2px solid #4a90e2;
    height: 24px;
    margin: 0 10px;
  }
  .opacity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: 20px;
    color: white;
  }

  .opacity-controls input {
    width: 60px;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
  }

  .opacity-controls button {
    background: #16213e;
    border: 1px solid #4a90e2;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
  }

  .opacity-controls button:hover {
    background: #4a90e2;
  }

  #customAlertModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .alert-content {
    background: #0f3460;
    padding: 20px;
    border-radius: 8px;
    min-width: 300px;
    border: 2px solid #4a90e2;
  }

  #customAlertMessage {
    color: white;
    text-align: center;
  }

  #floating-text-menu {
    position: absolute;
    background: #0f3460;
    padding: 15px;
    border-radius: 8px;
    color: white;
    width: 200px;
    height: 240px;
    display: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    z-index: 1000;
    font-size: 12px;
  }

  .menu-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
    margin-bottom: 15px;
  }

  .menu-row {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .menu-row label {
    min-width: 70px;
  }

  .menu-row select,
  .menu-row input {
    flex: 1;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
    font-size: 12px;
    width: calc(100% - 30px);
  }

  .outline-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .outline-row span {
    color: white;
    font-size: 12px;
  }

  .outline-row input[type="number"] {
    width: 40px;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
  }

  .outline-row input[type="color"] {
    width: 30px;
    padding: 0;
    border: 1px solid #4a90e2;
    background: #16213e;
  }
  .menu-row input[type="checkbox"] {
	  margin-left: 10px;
	}

  .menu-row input[type="color"] {
	  margin-left: 10px;
	}

  /* Modal Styles */
  #docSizeModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

	.doc-size-content {
	  background: #0f3460;
	  padding: 20px;
	  border-radius: 8px;
	  width: 500px;
	  height: auto;
	  border: 2px solid #4a90e2;
	  display: flex;
	  flex-direction: column;
	  justify-content: space-between;
	}

	.doc-size-header {
	  display: flex;
	  justify-content: space-between;
	  align-items: center;
	  margin-bottom: 20px;
	}

	.doc-size-header h2 {
	  color: white;
	  margin: 0;
	}

	.doc-size-header button {
	  background: none;
	  border: none;
	  color: white;
	  font-size: 20px;
	  cursor: pointer;
	}

	.doc-size-body {
	  display: flex;
	  flex-direction: column;
	  gap: 20px;
	}

	.size-row {
	  display: flex;
	  align-items: center;
	  justify-content: center;
	  gap: 10px;
	}

	.size-row span {
	  font-size: 1.5rem;
	  color: white;
	}

	.size-row input {
	  width: 60px;
	  text-align: center;
	}

	.doc-size-buttons {
	  display: flex;
	  justify-content: space-between;
	  gap: 10px;
	}

	.doc-size-buttons button {
	  background: #4a90e2;
	  color: white;
	  border: none;
	  padding: 10px;
	  border-radius: 4px;
	  cursor: pointer;
	  flex: 1;
	}

	.doc-size-buttons button:hover {
	  background: #3a70b2;
	}

	.doc-size-buttons button:not(:last-child) {
	  margin-right: 10px;
	}
#dynamicModal .modal-btn {
    background: #4a90e2;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.modal-content {
    background: #0f3460;
    border-radius: 8px;
    width: 90%;
    height: 90%;
    display: flex;
    flex-direction: column;
    border: 2px solid #4a90e2;
}

.modal-body {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.modal-footer {
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
}

.crop-btn {
    background: #16213e;
    border: 1px solid #4a90e2;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.crop-btn:hover {
    background: #4a90e2;
}	
.remove-color-btn {
    background-color: #0f3460;
    border: 2px solid #4a90e2;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s, color 0.3s;
    margin: 0 5px;
}
.remove-color-btn:hover {
    background-color: #4a90e2;
    color: white;
}

.remove-color-btn.active {
    background-color: #4a90e2;
    color: white;
    border-color: #4a90e2;
}
#sensitivityRange {
    -webkit-appearance: none;
    appearance: none;
    width: 100%;
    height: 8px;
    background: #16213e;
    outline: none;
    border: 2px solid #4a90e2;
    border-radius: 10px;
    margin: 10px 0;
    transition: opacity 0.2s;
}

#sensitivityRange:hover {
    opacity: 0.8;
}

#sensitivityRange::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #4a90e2;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
}

#sensitivityRange::-webkit-slider-thumb:hover {
    background: #3a70b2;
}

#sensitivityRange::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #4a90e2;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
}

#sensitivityRange::-moz-range-thumb:hover {
    background: #3a70b2;
}
#paintingCanvas {
    max-width: 100%;
    max-height: 100%;
    border: 1px solid #ccc;
}
/* Estilo dos botões do modal */
.modal-btn {
    background-color: #0f3460;
    color: #fff;
    border: 2px solid #4a90e2;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s, color 0.3s;
    margin: 0 5px;
}

.modal-btn:hover {
    background-color: #4a90e2;
    color: white;
}

.modal-btn.active {
    background-color: #4a90e2;
    color: white;
    border-color: #4a90e2;
}

/* Estilo do slider */
.modal-footer input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    width: 100px;
    height: 8px;
    background: #16213e;
    outline: none;
    border: 2px solid #4a90e2;
    border-radius: 10px;
    margin: 0 10px;
    transition: opacity 0.2s;
}

.modal-footer input[type="range"]:hover {
    opacity: 0.8;
}

.modal-footer input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #4a90e2;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
}

.modal-footer input[type="range"]::-webkit-slider-thumb:hover {
    background: #3a70b2;
}

.modal-footer input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #4a90e2;
    border-radius: 50%;
    cursor: pointer;
    transition: background 0.3s;
}

.modal-footer input[type="range"]::-moz-range-thumb:hover {
    background: #3a70b2;
}
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.modal-content {
    background: #0f3460;
    border-radius: 8px;
    width: 90%;
    max-width: 800px;
    display: flex;
    flex-direction: column;
    border: 2px solid #4a90e2;
}

.modal-body {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}

.slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}
.slider-container input[type="range"] {
    flex: 1;
}
.slider-container input[type="color"] {
    width: 30px;
    height: 30px;
    padding: 0;
}

.slider-value {
    min-width: 50px;
}
.export-item {
    position: relative;
}

resolution-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
    color: white;
}

.resolution-controls input {
    width: 80px;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: #16213e;
    color: white;
}

#layersList li.drop-above {
  border-top: 2px solid #4a90e2;
}

#layersList li.drop-below {
  border-bottom: 2px solid #4a90e2;
}

#layersList li.dragging {
  opacity: 0.5;
}
/* Estilo do Modal */
#dynamicModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    z-index: 10000;
}

#dynamicModal .modal-header {
    height: 40px;
    background: #0f3460;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    padding: 0 10px;
}

#dynamicModal .modal-btn {
    background: #4a90e2;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

#dynamicModal .modal-btn:hover {
    background: #357abd;
}

#dynamicIframe {
    flex: 1;
    background: white;
}
#floating-shape-menu {
  position: absolute;
  background: #0f3460;
  padding: 15px;
  border-radius: 8px;
  color: white;
  width: 200px;
  height: auto;
  display: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  z-index: 1000;
  font-size: 12px;
}

.menu-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
  margin-bottom: 15px;
}

.menu-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.menu-row label {
  min-width: 80px;
}

.menu-row input[type="number"] {
  width: 60px;
  padding: 4px;
  border-radius: 4px;
  border: 1px solid #4a90e2;
  background: #16213e;
  color: white;
  font-size: 12px;
}

.menu-row input[type="color"] {
  width: 30px;
  padding: 0;
  border: 1px solid #4a90e2;
  background: #16213e;
}

#export-svg-btn {
  background: #4a90e2;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  width: 100%;
}

#export-svg-btn:hover {
  background: #3a70b2;
}
.save-as-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

.save-as-modal-content {
    background: #0f3460;
    border-radius: 8px;
    width: 200px;
    height: 400px;
    display: flex;
    flex-direction: column;
    border: 2px solid #4a90e2;
    color: white;
}

.save-as-modal-header {
    padding: 10px;
    border-bottom: 1px solid #4a90e2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.save-as-modal-header h2 {
    margin: 0;
    font-size: 16px;
}

.save-as-modal-header button {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
}

.save-as-modal-body {
    padding: 10px;
    flex: 1;
    overflow-y: auto;
}
#vectorPreviewModal .modal-content {
    width: 100%;
    height: 100%; 
    display: flex;
    flex-direction: column;
    background: #0f3460;
    border: 2px solid #4a90e2;
    border-radius: 8px;
    overflow: hidden;
}

#vectorPreviewModal .modal-body {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
}
#vectorPreviewModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000;
}

#vectorPreviewContainer {
    flex: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto; 
    background-color: #0f3460;
    padding: 20px; 
}

#vectorPreviewContainer svg {
    transform: scale(1.5); 
    transform-origin: center center; 
}
.modal-footer button {
    background: #4a90e2;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}
.modal-footer button:hover {
    background: #3a70b2;
}

#detectionLevelModal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0);
    display: flex;
    justify-content: center;
    align-items: flex-end; 
    z-index: 1000;
    pointer-events: none; 
}

#detectionLevelModal .modal-content {
    background: #0f3460;
    border-radius: 8px;
    width: 400px;
    height: auto; 
    padding: 20px;
    border: 2px solid #4a90e2;
    color: white;
    pointer-events: auto; 
    margin-bottom: 20px;
}

#detectionLevelModal .modal-body {
    display: flex;
    align-items: center;
    gap: 20px;
}

#detectionLevelModal .slider-container {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

#detectionLevelModal .slider-label {
    font-size: 14px;
    white-space: nowrap;
}

#detectionLevelModal input[type="range"] {
    flex: 1; 
}

#detectionLevelModal .slider-value {
    font-size: 14px;
    font-weight: bold;
    min-width: 30px; 
    text-align: center;
}

/* Estilos do Modal de Ajustes de Imagem */
#imageAdjustModal {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #0f3460;
    padding: 15px;
    border-radius: 8px;
    border: 2px solid #4a90e2;
    z-index: 1000;
    color: white;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.modal-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.modal-row label {
    min-width: 80px;
}

.modal-row input[type="range"] {
    flex: 1;
}

.modal-row span {
    min-width: 40px;
    text-align: right;
}
</style>
</head>
<body>
<div id="customAlertModal" style="display: none;">
  <div class="alert-content">
    <div id="customAlertMessage"></div>
  </div>
</div>
<div id="top-menu">
 <div class="menu-item">
    Arquivo
    <div class="dropdown">
        <a href="javascript:void(0)" id="openDocumentBtn">
            Abrir Documento
            <span class="shortcut">Ctrl + O</span>
        </a>
        <a href="javascript:void(0)" id="saveDocumentBtn">
            Salvar Documento
            <span class="shortcut">Ctrl + S</span>
        </a>
        <a href="javascript:void(0)" class="document-size-item" id="docSizeBtn">
            Tamanho do Documento
        </a>
        <div class="separator"></div>
        <a href="javascript:void(0)" id="saveAsBtn">Exportar<span class="shortcut">Ctrl + E</span></a>
    </div>
</div>

  <div class="menu-item">
    Editar
    <div class="dropdown">
    <a href="javascript:void(0)" id="copyBtn">Copiar<span class="shortcut">Ctrl + C</span></a>
    <a href="javascript:void(0)" id="pasteBtn">Colar<span class="shortcut">Ctrl + V</span></a>
</div>
  </div>
  <div class="menu-item">
    Imagem
    <div class="dropdown">
	 <a href="javascript:void(0)" id="filtroscorBtn">Brilho - Contraste - Nitidez</a>
	<div class="separator"></div>
    <a href="javascript:void(0)" id="rotateBtn">Girar<input type="number" id="rotateInput" value="90" min="0" max="360" step="90"></a>
    <a href="javascript:void(0)" id="duplicateBtn">Duplicar<input type="number" id="duplicateInput" value="1" min="1" step="1"></a>
    <a href="javascript:void(0)" id="organizeBtn">Organizar<input type="number" id="organizeInput" value="0.1" min="0.1" step="0.1"></a>
    <a href="javascript:void(0)" id="alignVerticalBtn">Alinhar Verticalmente</a>
    <a href="javascript:void(0)" id="alignHorizontalBtn">Alinhar Horizontalmente</a>
    <a href="javascript:void(0)" id="flipVerticalBtn">Espelhar Verticalmente</a>
    <a href="javascript:void(0)" id="flipHorizontalBtn">Espelhar Horizontalmente</a>
</div>
  </div>
  <div class="menu-item">
    Texto
    <div class="dropdown">
      <a href="javascript:void(0)">Adicionar Texto</a>
      <a href="javascript:void(0)">Rasterizar Texto</a>
      <a href="javascript:void(0)">Converter em Forma</a>
      <a href="javascript:void(0)">Adicionar Fonte</a>
    </div>
  </div>
  <div class="menu-item">
    Filtro
    <div class="dropdown">
      <a href="javascript:void(0)">Desfoque</a>
      <a href="javascript:void(0)">Nitidez</a>
    </div>
  </div>
  <div class="menu-item">
    Guias
    <div class="dropdown">
      <a href="javascript:void(0)" id="addDefaultGuidesBtn">Adicionar Guias Padrão<span class="shortcut">F2</span></a>
      <a href="javascript:void(0)" class="guides-item" id="addGuidesBtn">
        Adicionar Guia
        <div class="guides-controls">
          <div class="guide-options">
            <button id="horizontalGuideBtn"  class="guide-btn selected">Horizontal</button>
            <button id="verticalGuideBtn" class="guide-btn">Vertical</button>
          </div>
          <div class="guide-options">
            <button id="singleGuideBtn" class="guide-btn selected">Uma Guia</button>
            <button id="multipleGuidesBtn" class="guide-btn">Várias Guias</button>
          </div>
          <div class="guide-position">
            <span>a cada (cm)</span>
            <input type="number" id="guidePositionInput" value="1" step="0.1" min="0" style="display: flex; margin: 0 auto; text-align: center;">
          </div>
			<button id="addGuideBtn" class="guide-btn selected">Adicionar</button>
        </div>
      </a>
      <a href="javascript:void(0)" id="removeGuidesBtn">Apagar Guias<span class="shortcut">Shift + F2</span></a>
    </div>
  </div>
  <div class="menu-item">
    Formas
    <div class="dropdown">
        <a href="javascript:void(0)" id="formaquadradoBtn">Quadrado</a>
    </div>
</div>
  <div class="menu-item">
    Extra
    <div class="dropdown">
		<a href="javascript:void(0)" id="fontepersonBtn">Fontes Personalizada</a>
        <a href="javascript:void(0)" id="calendarBtn">Calendário</a>
    </div>
</div>
  
  <div class="thick-separator"></div>
  <div class="size-controls">
    <span>↔</span>
    <input type="number" id="width-input" step="0.1" min="0">
    <button id="swap-dims">⇅</button>
    <span>↕</span>
    <input type="number" id="height-input" step="0.1" min="0">
    <button id="lock-ratio">🔓</button>
  </div>
  <div class="thick-separator"></div>
  <div class="opacity-controls" id="opacity-controls" style="display: none;">
    <span>Opacidade:</span>
    <input type="number" id="opacity-input" min="0" max="100" value="100">
	<button id="addContorno">Adicionar Contorno</button>
    <button id="export-png-btn">Exportar em PNG</button>
  </div>
  <div class="menu-item" style="margin-left: auto;">
        <button id="infoButton" style="background-color: yellow; color: black; border: none; padding: 8px 16px; border-radius: 4px; cursor: default;">
            CloudPhoto - Alfa - 07/Jan/25
        </button>
    </div>
</div>

<div id="left-menu">
<button class="tool-button" id="loadImageBtn" title="Atalho: I">
    <i class="fa-regular fa-image"></i>
    Importar Imagem
</button>
<button class="tool-button selected" id="moveBtn" title="Atalho: V">
    <i class="fa-solid fa-up-down-left-right"></i>
    Mover
</button>
  <div class="separator"></div>
<button class="tool-button" id="selectBtn" title="Atalho: M">
    <i class="fa-solid fa-vector-square" style="color: #ffffff;"></i>
    Selecionar
</button>
<button class="tool-button" id="textoBtn" title="Atalho: T">
    <i class="fa-solid fa-font"></i>
    Texto
</button>
<button id="btnPincel" class="tool-button" title="Atalho: B">
    <i class="fa-solid fa-palette"></i>
    Pincel
</button>
<button id="btnBalde" class="tool-button" title="Atalho: G">
    <i class="fa-solid fa-palette"></i>
    Balde
</button>
<button id="btnBorracha" class="tool-button" title="Atalho: E">
    <i class="fa-solid fa-eraser"></i>
    Borracha
</button>
  <div class="separator"></div>
<button id="removeCorCliqueBtn" class="tool-button" title="Atalho: W">
    <i class="fa-solid fa-wand-magic-sparkles"></i>
    Remover Cor Clique
</button>
<button id="removeCorTotalBtn"  class="tool-button">
    <i class="fa-solid fa-wand-magic-sparkles"></i>
    Remover Cor Total
</button>
  <div class="separator"></div>
<button id="cropImageBtn" class="tool-button" title="Atalho: C">
    <i class="fa-solid fa-scissors"></i>
    Recortar
</button>
<button id="extractRegionsBtn" class="tool-button">
    <i class="fa-solid fa-icons"></i>
    Extrair
</button>
<button id="vectorizePBBtn" class="tool-button">
    <i class="fa-solid fa-bezier-curve"></i>
    Vetor PB
</button>

  <input type="file" id="fileInput" accept="image/*" multiple>
  <input type="file" id="loadDocInput" accept=".cloudapp" style="display: none;">
</div>
<div id="canvas-container">
  <canvas id="canvas"></canvas>
</div>
<div id="right-menu">
  <ul id="layersList"></ul>
  <div class="layers-buttons">
    <button class="layer-btn" id="newLayerBtn">
      <i class="fa-solid fa-plus"></i>
    </button>
    <button class="layer-btn" id="deleteLayerBtn">
      <i class="fa-solid fa-trash"></i>
    </button>
    <button class="layer-btn" id="centerLayerBtn">
      <i class="fa-solid fa-arrows-to-circle"></i>
    </button>
  </div>
</div>
<div id="floating-text-menu">
  <div class="menu-group">
    <div class="menu-row">
      <label>Fonte:</label>
      <select id="font-family">
        <option value="Arial" style="font-family: Arial;">Arial</option>
                      <option value="Arial Black" style="font-family: 'Arial Black';">Arial Black</option>
                      <option value="Brush Script MT" style="font-family: 'Brush Script MT';">Brush Script MT</option>
                      <option value="Bookman Old Style" style="font-family: 'Bookman Old Style';">Bookman Old Style</option>
                      <option value="Comic Sans MS" style="font-family: 'Comic Sans MS';">Comic Sans MS</option>
                      <option value="Courier" style="font-family: Courier;">Courier</option>
                      <option value="Dancing Script" style="font-family: 'Dancing Script';">Dancing Script</option>
                      <option value="Impact" style="font-family: Impact;">Impact</option>
                      <option value="Lucida Handwriting" style="font-family: 'Lucida Handwriting';">Lucida Handwriting</option>
                      <option value="Lucida Sans Unicode" style="font-family: 'Lucida Sans Unicode';">Lucida Sans Unicode</option>
                      <option value="Papyrus" style="font-family: Papyrus;">Papyrus</option>
                      <option value="Segoe Print" style="font-family: 'Segoe Print';">Segoe Print</option>
                      <option value="Segoe Script" style="font-family: 'Segoe Script';">Segoe Script</option>
                      <option value="Segoe UI" style="font-family: 'Segoe UI';">Segoe UI</option>
                      <option value="Times New Roman" style="font-family: 'Times New Roman';">Times New Roman</option>
                      <option value="Trebuchet MS" style="font-family: 'Trebuchet MS';">Trebuchet MS</option>
                      <option value="Verdana" style="font-family: Verdana;">Verdana</option>
                      <option value="Monotype Corsiva" style="font-family: 'Monotype Corsiva';">Monotype Corsiva</option>
                      <option value="Mistral" style="font-family: Mistral;">Mistral</option>
                      <option value="Freestyle Script" style="font-family: 'Freestyle Script';">Freestyle Script</option>
                      <option value="Bradley Hand ITC" style="font-family: 'Bradley Hand ITC';">Bradley Hand ITC</option>
                      <option value="Edwardian Script ITC" style="font-family: 'Edwardian Script ITC';">Edwardian Script ITC</option>
                      <option value="Vivaldi" style="font-family: Vivaldi;">Vivaldi</option>
                      <option value="Rage Italic" style="font-family: 'Rage Italic';">Rage Italic</option>
                    </select>
    </div>
    <div class="menu-row">
      <label>Tamanho:</label>
      <input type="number" id="font-size" min="1" value="20">
    </div>
    <div class="menu-row">
      <label>Cor:</label>
      <input type="color" id="font-color" value="#000000">
    </div>
	<div class="menu-row">
	  <label>Seg. Cor:</label>
	  <input type="checkbox" id="gradient-checkbox">
	  <input type="color" id="gradient-color" value="#000000">
	</div>
    <div class="menu-row">
      <label>Alinhamento:</label>
      <select id="text-align">
        <option value="left">Esquerda</option>
        <option value="center">Centro</option>
        <option value="right">Direita</option>
      </select>
    </div>
    <div class="outline-row">
	  <span>Contorno:</span>
      <input type="checkbox" id="second-color-check" unchecked>
      <input type="number" class="outline-size" value="0" min="0" max="20" step="0.1">
      <input type="color" class="outline-color" value="#000000">
    </div>
  </div>
</div>

<div id="docSizeModal" style="display: none;">
  <div class="doc-size-content">
    <div class="doc-size-header">
      <h2>Tamanho do Documento</h2>
      <button id="closeDocSizeModal">&times;</button>
    </div>
    <div class="doc-size-body">
      <div class="doc-size-controls">
        <div class="size-row">
          <span>↔</span>
          <input type="number" id="doc-width-input" step="0.1" min="0" value="21">
          <button id="doc-swap-dims">⇅</button>
          <span>↕</span>
          <input type="number" id="doc-height-input" step="0.1" min="0" value="29.7">
          <button id="doc-lock-ratio">🔓</button>
        </div>
      </div>
      <div class="doc-size-buttons">
        <button id="setA4Vertical">A4 Vertical</button>
        <button id="setA4Horizontal">A4 Horizontal</button>
        <button id="closeDocSizeModalBtn">Fechar</button>
        <button id="doc-size-ok">Salvar</button>
      </div>
    </div>
  </div>
</div>
<div id="cropperModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="crop-container">
                    <img id="cropperImage" src="">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn" id="cancelCropBtn">Cancelar</button>
                <button class="save-btn" id="saveCropBtn">Salvar</button>
            </div>
        </div>
    </div>
	<div id="cropModal" class="modal-overlay" style="display: none;">
		<div class="modal-content">
			<div class="modal-body">
				<img id="cropImage" src="" alt="Imagem para recorte" style="max-width: 100%; max-height: 100%;">
			</div>
			<div class="modal-footer">
				<button id="closeCropModal" class="crop-btn">Fechar</button>
				<button id="saveCrop" class="crop-btn">Salvar</button>
			</div>
		</div>
	</div>
	<div id="paintingModal" class="modal-overlay" style="display: none;">
		<div class="modal-content">
			<div class="modal-body">
				<canvas id="paintingCanvas"></canvas>
			</div>
			<div class="modal-footer">
				<button id="closePaintingModal" class="modal-btn">Fechar</button>
				<button id="savePaintingModal" class="modal-btn">Salvar</button>
				<button id="undoPaintingModal" class="modal-btn">Voltar</button>
			</div>
		</div>
	</div>
	
<div id="outlineModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-body">
            <div class="image-container">
                <div class="image-wrapper">
                    <img id="outlineImagePreview" class="image-preview">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <div class="slider-container">
                <input type="range" id="outlineSlider1" min="0" max="20" value="0">
                <span class="slider-value" id="sliderValue1">0px</span>
                <input type="color" id="colorPicker1" value="#000000">
            </div>
            <div class="slider-container">
                <input type="range" id="outlineSlider2" min="0" max="20" value="0">
                <span class="slider-value" id="sliderValue2">0px</span>
                <input type="color" id="colorPicker2" value="#ff0000">
            </div>
            <button id="applyOutlineBtn" class="modal-btn">Aplicar Contorno</button>
            <button id="closeOutlineModal" class="modal-btn">Fechar</button>
        </div>
    </div>
</div>

<div id="dynamicModal" class="modal-overlay" style="display: none;">
    <div class="modal-header">
        <button id="closeDynamicModal" class="modal-btn">Fechar</button>
    </div>
    <iframe id="dynamicIframe" src="" style="width: 100%; height: calc(100% - 40px); border: none;"></iframe>
</div>

<div id="floating-shape-menu" style="display: none;">
  <div class="menu-group">
    <div class="menu-row">
      <label>Cor:</label>
      <input type="color" id="shape-color" value="#000000">
    </div>
    <div class="menu-row">
      <label>Traço:</label>
      <input type="number" id="stroke-width" min="0" value="0">
      <input type="color" id="stroke-color" value="#000000">
    </div>
  </div>
</div>

<div id="saveAsModalOverlay" class="save-as-modal-overlay" style="display: none;">
    <div class="save-as-modal-content">
        <div class="save-as-modal-header">
            <h2>Salvar Como</h2>
            <button id="closeSaveAsModal">&times;</button>
        </div>
        <div class="save-as-modal-body">
            <div class="resolution-controls">
                <label for="resolutionInput">Resolução (DPI):</label>
                <input type="number" id="resolutionInput" value="150" min="72" max="600" step="1">
            </div>
            <button class="tool-button" id="exportPNGBtn" style="font-size: 15px;">Exportar como PNG</button>
            <button class="tool-button" id="exportJPGBtn" style="font-size: 15px;">Exportar como JPG</button>
            <button class="tool-button" id="exportPDFBtn" style="font-size: 15px;">Exportar como PDF</button>
			<button class="tool-button" id="exportsoSVGBtn" style="font-size: 15px;">Exportar como Vetor</button>
        </div>
    </div>
</div>

<div id="vectorPreviewModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div id="vectorPreviewContainer">
            <!-- O conteúdo vetorial será renderizado aqui -->
        </div>
        <div class="modal-footer">
            <button id="downloadVectorBtn" class="modal-btn">Baixar</button>
            <button id="closeVectorPreviewModalBtn" class="modal-btn">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal do Slider de Detecção -->
<div id="detectionLevelModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-body">
            <div class="slider-container">
                <label for="detection-level" class="slider-label">Sensibilidade:</label>
                <input type="range" id="detection-level" min="1" max="200" value="30">
                <span class="slider-value" id="sliderValue">30</span>
                <button id="undoColorRemovalBtn" class="modal-btn">Desfazer</button>
            </div>
        </div>
    </div>
</div>

<div id="imageAdjustModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-row">
            <label for="brightnessSlider">Brilho:</label>
            <input type="range" id="brightnessSlider" min="-100" max="100" value="0">
            <span id="brightnessValue">0%</span>
        </div>
        <div class="modal-row">
            <label for="contrastSlider">Contraste:</label>
            <input type="range" id="contrastSlider" min="-100" max="100" value="0">
            <span id="contrastValue">0%</span>
        </div>
        <div class="modal-row">
            <label for="saturationSlider">Saturação:</label>
            <input type="range" id="saturationSlider" min="-100" max="100" value="0">
            <span id="saturationValue">0%</span>
        </div>
        <div class="modal-row">
            <label for="sharpnessCheckbox">Nitidez:</label>
            <input type="checkbox" id="sharpnessCheckbox">
        </div>
    </div>
</div>

<script src="https://nkmplay.github.io/cgf/ferramentas/modalselect.js"></script>
<script src="https://nkmplay.github.io/cgf/ferramentas/dragdrop.js"></script>
<script src="https://nkmplay.github.io/cgf/ferramentas/exportar.js"></script>
<script src="https://nkmplay.github.io/cgf/ferramentas/fucoesgerais.js"></script>
<script src="https://nkmplay.github.io/cgf/ferramentas/cverp.js"></script>
<script src="https://nkmplay.github.io/cgf/ferramentas/exportvetor.js"></script>
<script>
document.getElementById('cropImageBtn').addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            openCropModal(canvas, activeObject);
        });

        document.getElementById('vectorizePBBtn').addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            openVectorizeModal(canvas, activeObject);
        });

        document.getElementById('extractRegionsBtn').addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            openExtractRegionsModal(canvas, activeObject);
        });

        document.getElementById('btnPincel').addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            openPaintingModal(canvas, activeObject, 'brush');
        });

        document.getElementById('btnBorracha').addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            openPaintingModal(canvas, activeObject, 'eraser');
        });

        document.getElementById('btnBalde').addEventListener('click', () => {
            const activeObject = canvas.getActiveObject();
            openPaintingModal(canvas, activeObject, 'bucket');
        });
		
		document.getElementById('selectBtn').addEventListener('click', function () {
			initSelectModal(canvas);
		});

//--------------------------------- Seção Variáveis Globais ---------------------------------

const DPI = 96;
const CM_TO_PX = DPI / 2.54;

const container = document.getElementById('canvas-container');
const canvas = new fabric.Canvas('canvas', {
  preserveObjectStacking: true,
  selection: true
});

initializeGuides(canvas);

let isRatioLocked = false;
let aspectRatio = 1;
const widthInput = document.getElementById('width-input');
const heightInput = document.getElementById('height-input');
const lockRatioBtn = document.getElementById('lock-ratio');
const swapDimsBtn = document.getElementById('swap-dims');
const docSizeOkBtn = document.getElementById('doc-size-ok');
let docIsRatioLocked = false;
const docWidthInput = document.getElementById('doc-width-input');
const docHeightInput = document.getElementById('doc-height-input');
const docLockRatioBtn = document.getElementById('doc-lock-ratio');
const docSwapDimsBtn = document.getElementById('doc-swap-dims');
let docAspectRatio = 21 / 29.7;
let draggedItem = null;
let floatingMenu = document.getElementById('floating-text-menu');

//--------------------------------- Seção Canva e Dimensoes Shape Folha ---------------------------------

function convertDimensions(value, fromUnit, toUnit) {
  if (fromUnit === 'px' && toUnit === 'cm') {
    return value / CM_TO_PX;
  } else if (fromUnit === 'cm' && toUnit === 'px') {
    return value * CM_TO_PX;
  }
  return value;
}

function calculateProperScale(object, desiredWidthCm, desiredHeightCm) {
  const desiredWidthPx = convertDimensions(desiredWidthCm, 'cm', 'px');
  const desiredHeightPx = convertDimensions(desiredHeightCm, 'cm', 'px');

  return {
    scaleX: desiredWidthPx / object.width,
    scaleY: desiredHeightPx / object.height
  };
}

function constrainToA4(object) {
  const a4Width = 21 * CM_TO_PX;
  const a4Height = 29.7 * CM_TO_PX;
  const a4Page = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (!a4Page) return;

  const objectWidth = object.width * object.scaleX;
  const objectHeight = object.height * object.scaleY;

  if (objectWidth > a4Width || objectHeight > a4Height) {
  }
}

function updatePageDimensions() {
  const width = 21 * CM_TO_PX;
  const height = 29.7 * CM_TO_PX;

  const existingFolha = canvas.getObjects().filter(obj => obj.id === 'CloudFolha');
  existingFolha.forEach(obj => canvas.remove(obj));

  const a4Page = new fabric.Rect({
    id: 'CloudFolha',
    left: (canvas.width - width) / 2,
    top: (canvas.height - height) / 2,
    width: width,
    height: height,
    fill: 'white',
    selectable: false,
    evented: false,
    excludeFromExport: true
  });

  canvas.add(a4Page);
  canvas.sendToBack(a4Page);
  canvas.renderAll();
}

function createCloudFolha() {
    const width = 21 * CM_TO_PX;
    const height = 29.7 * CM_TO_PX;

    const cloudFolha = new fabric.Rect({
        id: 'CloudFolha',
        left: (canvas.width - width) / 2,
        top: (canvas.height - height) / 2,
        width: width,
        height: height,
        fill: 'white',
        selectable: false,
        evented: false,
        excludeFromExport: true
    });

    canvas.add(cloudFolha);
    canvas.sendToBack(cloudFolha);
    canvas.renderAll();

    const widthCm = convertDimensions(width, 'px', 'cm');
    const heightCm = convertDimensions(height, 'px', 'cm');
    widthInput.value = widthCm.toFixed(1);
    heightInput.value = heightCm.toFixed(1);
}

window.addEventListener('load', function () {
    createCloudFolha();
    resizeCanvas();
});

function resizeCanvas() {
    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;

    canvas.setWidth(containerWidth);
    canvas.setHeight(containerHeight);

    const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
    if (!cloudFolha) return;

    const scaleX = (containerWidth * 0.8) / cloudFolha.width;
    const scaleY = (containerHeight * 0.8) / cloudFolha.height;
    const zoom = Math.min(scaleX, scaleY);

    const objectPositions = [];
    canvas.getObjects().forEach(obj => {
        if (obj.id !== 'CloudFolha') {
            objectPositions.push({
                object: obj,
                relativeLeft: (obj.left - cloudFolha.left) / cloudFolha.width,
                relativeTop: (obj.top - cloudFolha.top) / cloudFolha.height,
                originalScaleX: obj.scaleX,
                originalScaleY: obj.scaleY
            });
        }
    });

    canvas.setZoom(zoom);

    const centerX = (containerWidth / zoom - cloudFolha.width) / 2;
    const centerY = (containerHeight / zoom - cloudFolha.height) / 2;

    cloudFolha.set({
        left: centerX,
        top: centerY
    });

    objectPositions.forEach(pos => {
        const obj = pos.object;
        obj.set({
            left: centerX + (pos.relativeLeft * cloudFolha.width),
            top: centerY + (pos.relativeTop * cloudFolha.height),
            scaleX: pos.originalScaleX,
            scaleY: pos.originalScaleY
        });
    });

    canvas.renderAll();
}


window.addEventListener('resize', () => {
  resizeCanvas(); 
  updateTextPositions(); 
});

function updateTextPositions() {
  const objects = canvas.getObjects();
  const zoom = canvas.getZoom();
  const a4Page = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (a4Page) {
    objects.forEach(obj => {
      if (obj.type === 'i-text' && obj.id !== 'CloudFolha') {
        const relativeLeft = (obj.left - a4Page.left) / a4Page.width;
        const relativeTop = (obj.top - a4Page.top) / a4Page.height;

        obj.set({
          left: a4Page.left + (relativeLeft * a4Page.width),
          top: a4Page.top + (relativeTop * a4Page.height)
        });
      }
    });
  }

  canvas.renderAll();
}
//--------------------------------- Seção Eventos ---------------------------------

canvas.on({
  'selection:created': function () {
    updateSizeInputs();
    updateOpacityControls();

    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      updateFloatingTextMenu();
    } else {
      document.getElementById('floating-text-menu').style.display = 'none';
    }
  },

  'selection:updated': function () {
    updateSizeInputs();
    updateOpacityControls();

    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      updateFloatingTextMenu();
    } else {
      document.getElementById('floating-text-menu').style.display = 'none';
    }
  },

  'selection:cleared': function () {
    updateOpacityControls();

    const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
    if (cloudFolha) {
      const widthCm = convertDimensions(cloudFolha.width, 'px', 'cm');
      const heightCm = convertDimensions(cloudFolha.height, 'px', 'cm');
      widthInput.value = widthCm.toFixed(1);
      heightInput.value = heightCm.toFixed(1);
    }

    document.getElementById('floating-text-menu').style.display = 'none';
  },

  'object:added': updateSizeInputs,
  'object:removed': updateSizeInputs,
  'object:modified': function () {
    updateSizeInputs();

    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      updateFloatingTextMenu();
    }
  },

  'object:moving': function () {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      updateFloatingTextMenu();
    }
  },

  'object:scaling': function () {
    updateSizeInputs();

    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      updateFloatingTextMenu();
    }
  }
});


canvas.on('mouse:wheel', function (opt) {
  const delta = opt.e.deltaY;
  let zoom = canvas.getZoom();
  zoom = delta > 0 ? zoom / 1.1 : zoom * 1.1;
  zoom = Math.min(Math.max(0.01, zoom), 20);
  canvas.zoomToPoint({
    x: opt.e.offsetX,
    y: opt.e.offsetY
  }, zoom);
  opt.e.preventDefault();
  opt.e.stopPropagation();
});

canvas.on('object:modified', function (e) {
    const obj = e.target;
    if (obj) {
        obj.setCoords();
        canvas.renderAll();

        if (obj.type === 'i-text' || obj.type === 'text') {
            if (obj.fill && typeof obj.fill === 'object') {
                try {
                    if (obj.fill.type === 'linear' || obj.fill.type === 'radial') {
                        const gradientObj = new fabric.Gradient(obj.fill);
                        obj.set('fill', gradientObj);
                    } else if (obj.fill.r !== undefined && obj.fill.g !== undefined && obj.fill.b !== undefined) {
                        const hexColor = rgbToHex(obj.fill.r, obj.fill.g, obj.fill.b);
                        obj.set('fill', hexColor);
                    } else {
                        obj.set('fill', '#000000');
                    }
                } catch (error) {
                    console.warn('Erro ao atualizar gradiente ou cor:', error);
                    obj.set('fill', '#000000');
                }
            }
        }
        updateLayersList();
    }
});

canvas.on('text:changed', updateLayersList);

canvas.on('object:added', updateLayersList);

canvas.on('object:removed', function (e) { if (e.target && e.target.id === 'CloudFolha') { canvas.add(e.target); canvas.sendToBack(e.target); } updateLayersList(); });

canvas.on('object:scaling', function(e) {
  const object = e.target;
  if (!object || object.id === 'CloudFolha') return;

  constrainToA4(object);

  if (object.type === 'i-text') {
    const scaledWidth = object.width * object.scaleX;
    const scaledHeight = object.height * object.scaleY;

    const widthCm = convertDimensions(scaledWidth, 'px', 'cm');
    const heightCm = convertDimensions(scaledHeight, 'px', 'cm');
    widthInput.value = widthCm.toFixed(1);
    heightInput.value = heightCm.toFixed(1);

    const originalFontSize = object.get('fontSize');
    const newFontSize = Math.round(originalFontSize * object.scaleX);

    const fontSizeInput = document.getElementById('font-size');
    if (fontSizeInput) {
      fontSizeInput.value = newFontSize;
    }

    object.set({
      fontSize: newFontSize,
      scaleX: 1,
      scaleY: 1
    });
  } else {
    updateSizeInputs();
  }

  canvas.renderAll();
});


//--------------------------------- Seção Alerta Personalizado ---------------------------------

function showCustomAlert(message) {
  const modal = document.getElementById('customAlertModal');
  const messageElement = document.getElementById('customAlertMessage');
  messageElement.textContent = message;
  modal.style.display = 'flex';
}

function closeCustomAlert() {
  const modal = document.getElementById('customAlertModal');
  modal.style.display = 'none';
}

document.getElementById('customAlertModal').addEventListener('click', function (e) {
  if (e.target === this) {
    closeCustomAlert();
  }
});

//--------------------------------- Seção dimensões da imagem ---------------------------------

function updateSizeInputs() {
  const activeObjects = canvas.getActiveObjects(); // Verifica múltiplos objetos
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (activeObjects.length === 0 && cloudFolha) {
    // Exibe dimensões da folha
    const widthCm = convertDimensions(cloudFolha.width, 'px', 'cm');
    const heightCm = convertDimensions(cloudFolha.height, 'px', 'cm');
    widthInput.value = widthCm.toFixed(1);
    heightInput.value = heightCm.toFixed(1);
  } else if (activeObjects.length === 1) {
    // Exibe dimensões do único objeto selecionado
    const activeObject = activeObjects[0];
    if (activeObject.id !== 'CloudFolha') {
      const scaledWidth = activeObject.width * activeObject.scaleX;
      const scaledHeight = activeObject.height * activeObject.scaleY;
      widthInput.value = convertDimensions(scaledWidth, 'px', 'cm').toFixed(1);
      heightInput.value = convertDimensions(scaledHeight, 'px', 'cm').toFixed(1);
    } else {
      widthInput.value = '';
      heightInput.value = '';
    }
  } else if (activeObjects.length > 1) {
    // Verifica se todos os objetos têm o mesmo tamanho
    const allSameSize = allSelectedObjectsHaveSameSize();
    if (allSameSize) {
      const firstObject = activeObjects[0];
      const widthCm = convertDimensions(firstObject.width * firstObject.scaleX, 'px', 'cm');
      const heightCm = convertDimensions(firstObject.height * firstObject.scaleY, 'px', 'cm');
      widthInput.value = widthCm.toFixed(1);
      heightInput.value = heightCm.toFixed(1);
    } else {
      // Objetos com tamanhos diferentes
      widthInput.value = '';
      heightInput.value = '';
    }
  }
}
function allSelectedObjectsHaveSameSize() {
  const activeObjects = canvas.getActiveObjects();
  if (activeObjects.length === 0) return false;

  const firstObject = activeObjects[0];
  const firstWidth = firstObject.width * firstObject.scaleX;
  const firstHeight = firstObject.height * firstObject.scaleY;

  return activeObjects.every(obj => {
    const objWidth = obj.width * obj.scaleX;
    const objHeight = obj.height * obj.scaleY;
    return objWidth === firstWidth && objHeight === firstHeight;
  });
}

widthInput.addEventListener('change', () => {
  const activeObjects = canvas.getActiveObjects();
  const newWidthCm = parseFloat(widthInput.value);
  const newWidthPx = convertDimensions(newWidthCm, 'cm', 'px');

  if (activeObjects.length > 1) {
    activeObjects.forEach(obj => {
      if (obj.id !== 'CloudFolha') {
        obj.set('scaleX', newWidthPx / obj.width);
      }
    });
  } else if (activeObjects.length === 1) {
    const activeObject = activeObjects[0];
    if (activeObject.id !== 'CloudFolha') {
      activeObject.set('scaleX', newWidthPx / activeObject.width);
    }
  }

  canvas.renderAll();
});
heightInput.addEventListener('change', () => {
  const activeObjects = canvas.getActiveObjects();
  const newHeightCm = parseFloat(heightInput.value);
  const newHeightPx = convertDimensions(newHeightCm, 'cm', 'px');

  if (activeObjects.length > 1) {
    activeObjects.forEach(obj => {
      if (obj.id !== 'CloudFolha') {
        obj.set('scaleY', newHeightPx / obj.height);
      }
    });
  } else if (activeObjects.length === 1) {
    const activeObject = activeObjects[0];
    if (activeObject.id !== 'CloudFolha') {
      activeObject.set('scaleY', newHeightPx / activeObject.height);
    }
  }

  canvas.renderAll();
});


heightInput.addEventListener('change', () => {
  const activeObjects = canvas.getActiveObjects();
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
  const newHeightCm = parseFloat(heightInput.value);
  const newHeightPx = convertDimensions(newHeightCm, 'cm', 'px');

  if (activeObjects.length > 0) {
    activeObjects.forEach(obj => {
      if (obj.id !== 'CloudFolha') {
        const scale = newHeightPx / obj.height;
        obj.set('scaleY', scale);
        if (isRatioLocked) {
          obj.set('scaleX', scale);
        }
      }
    });
  } else if (cloudFolha) {
    cloudFolha.set('height', newHeightPx);
  } else {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.id !== 'CloudFolha') {
      updateObjectSize(heightInput, 'height');
    }
  }

  canvas.renderAll();
});


function updateObjectSize(input, dimension) {
  const activeObjects = canvas.getActiveObjects();
  if (activeObjects.length === 0) return;

  activeObjects.forEach(activeObject => {
    if (activeObject.id === 'CloudFolha') return;

    const newValueCm = parseFloat(input.value);
    const newValuePx = convertDimensions(newValueCm, 'cm', 'px');

    if (activeObject.type === 'i-text') {
      const currentWidth = activeObject.width * activeObject.scaleX;
      const currentHeight = activeObject.height * activeObject.scaleY;

      if (dimension === 'width') {
        const scale = newValuePx / currentWidth;
        const newFontSize = Math.round(activeObject.fontSize * scale);

        activeObject.set({
          fontSize: newFontSize,
          scaleX: 1,
          scaleY: 1
        });

        if (isRatioLocked) {
          const heightScale = scale;
          const newHeightFontSize = Math.round(activeObject.fontSize * heightScale);
          activeObject.set({
            fontSize: newHeightFontSize,
            scaleY: 1
          });
          const newHeight = convertDimensions(activeObject.height, 'px', 'cm');
          heightInput.value = newHeight.toFixed(1);
        }

        document.getElementById('font-size').value = newFontSize;
      } else {
        const scale = newValuePx / currentHeight;
        const newFontSize = Math.round(activeObject.fontSize * scale);

        activeObject.set({
          fontSize: newFontSize,
          scaleX: 1,
          scaleY: 1
        });

        if (isRatioLocked) {
          const widthScale = scale;
          const newWidthFontSize = Math.round(activeObject.fontSize * widthScale);
          activeObject.set({
            fontSize: newWidthFontSize,
            scaleX: 1
          });
          const newWidth = convertDimensions(activeObject.width, 'px', 'cm');
          widthInput.value = newWidth.toFixed(1);
        }

        document.getElementById('font-size').value = newFontSize;
      }
    } else {
      let scale;
      if (dimension === 'width') {
        scale = newValuePx / activeObject.width;
        activeObject.set('scaleX', scale);

        if (isRatioLocked) {
          activeObject.set('scaleY', scale);
          const newHeight = convertDimensions(activeObject.height * scale, 'px', 'cm');
          heightInput.value = newHeight.toFixed(1);
        }
      } else {
        scale = newValuePx / activeObject.height;
        activeObject.set('scaleY', scale);

        if (isRatioLocked) {
          activeObject.set('scaleX', scale);
          const newWidth = convertDimensions(activeObject.width * scale, 'px', 'cm');
          widthInput.value = newWidth.toFixed(1);
        }
      }
    }

    constrainToA4(activeObject);
  });

  canvas.renderAll();
}

swapDimsBtn.addEventListener('click', () => {
  const activeObject = canvas.getActiveObject();
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (activeObject && activeObject.id !== 'CloudFolha') {
    const currentWidth = activeObject.width * activeObject.scaleX;
    const currentHeight = activeObject.height * activeObject.scaleY;
    activeObject.set({
      scaleX: currentHeight / activeObject.width,
      scaleY: currentWidth / activeObject.height
    });
  } else if (cloudFolha) {
    const currentWidth = cloudFolha.width;
    const currentHeight = cloudFolha.height;
    cloudFolha.set({
      width: currentHeight,
      height: currentWidth
    });
  }

  canvas.renderAll();
  updateSizeInputs();
});
widthInput.addEventListener('change', () => updateObjectSize(widthInput, 'width'));
heightInput.addEventListener('change', () => updateObjectSize(heightInput, 'height'));

widthInput.addEventListener('input', () => {
  const activeObject = canvas.getActiveObject();
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (isRatioLocked) {
    const newWidthCm = parseFloat(widthInput.value);
    const newWidthPx = convertDimensions(newWidthCm, 'cm', 'px');
    const newHeightPx = newWidthPx / aspectRatio;
    const newHeightCm = convertDimensions(newHeightPx, 'px', 'cm');

    if (activeObject && activeObject.id !== 'CloudFolha') {
      activeObject.set('scaleX', newWidthPx / activeObject.width);
      activeObject.set('scaleY', newHeightPx / activeObject.height);
    } else if (cloudFolha) {
      cloudFolha.set('width', newWidthPx);
      cloudFolha.set('height', newHeightPx);
    }

    heightInput.value = newHeightCm.toFixed(1);
  } else {
    if (activeObject && activeObject.id !== 'CloudFolha') {
      updateObjectSize(widthInput, 'width');
    } else if (cloudFolha) {
      const newWidthCm = parseFloat(widthInput.value);
      const newWidthPx = convertDimensions(newWidthCm, 'cm', 'px');
      cloudFolha.set('width', newWidthPx);
    }
  }

  canvas.renderAll();
});

heightInput.addEventListener('input', () => {
  const activeObject = canvas.getActiveObject();
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (isRatioLocked) {
    const newHeightCm = parseFloat(heightInput.value);
    const newHeightPx = convertDimensions(newHeightCm, 'cm', 'px');
    const newWidthPx = newHeightPx * aspectRatio;
    const newWidthCm = convertDimensions(newWidthPx, 'px', 'cm');

    if (activeObject && activeObject.id !== 'CloudFolha') {
      activeObject.set('scaleY', newHeightPx / activeObject.height);
      activeObject.set('scaleX', newWidthPx / activeObject.width);
    } else if (cloudFolha) {
      cloudFolha.set('height', newHeightPx);
      cloudFolha.set('width', newWidthPx);
    }

    widthInput.value = newWidthCm.toFixed(1);
  } else {
    if (activeObject && activeObject.id !== 'CloudFolha') {
      updateObjectSize(heightInput, 'height');
    } else if (cloudFolha) {
      const newHeightCm = parseFloat(heightInput.value);
      const newHeightPx = convertDimensions(newHeightCm, 'cm', 'px');
      cloudFolha.set('height', newHeightPx);
    }
  }

  canvas.renderAll();
});

function getObjectSizeInCm(object) {
  return {
    width: (object.width * object.scaleX) / CM_TO_PX,
    height: (object.height * object.scaleY) / CM_TO_PX
  };
}

//--------------------------------- Seção Histórico ---------------------------------

const canvasState = {
    undoStack: [],
    redoStack: [],
    maxStates: 10,
    isUndoOrRedoing: false,
    isInitialized: false,
    background: null,
    hasFirstObject: false
};

// Função para inicializar o histórico
function initializeHistory() {
    if (canvasState.isInitialized) return;
    const objects = canvas.getObjects().filter(obj => obj.id !== 'CloudFolha');
    if (objects.length > 0) {
        const currentState = canvas.toJSON(['id']);
        canvasState.undoStack = [JSON.stringify(currentState)];
        canvasState.isInitialized = true;
        canvasState.hasFirstObject = true;
    }
}

// Função para salvar o estado atual do canvas
function saveState() {
    if (canvasState.isUndoOrRedoing || !canvasState.hasFirstObject) return;
    if (!canvasState.background) {
        canvasState.background = canvas.backgroundImage;
    }
    const currentState = canvas.toJSON(['id']);
    const state = JSON.stringify(currentState);
    if (canvasState.undoStack.length === 0 || state !== canvasState.undoStack[canvasState.undoStack.length - 1]) {
        canvasState.undoStack.push(state);
        if (canvasState.undoStack.length > canvasState.maxStates) {
            canvasState.undoStack.shift();
        }
        ensureCloudFolhaAtBottom();
        canvasState.redoStack = [];
    }
}

// Função para desfazer a última ação
function undo() {
    if (canvasState.undoStack.length > 1) {
        canvasState.isUndoOrRedoing = true;
        const currentState = JSON.stringify(canvas.toJSON(['id']));
        canvasState.redoStack.push(currentState);
        canvasState.undoStack.pop();
        const prevState = JSON.parse(canvasState.undoStack[canvasState.undoStack.length - 1]);
        const pattern = canvas.backgroundImage || canvas.backgroundColor;
        canvas.clear();
        canvas.loadFromJSON(prevState, () => {
            canvas.setBackgroundColor(pattern, canvas.renderAll.bind(canvas));
            canvas.renderAll();
            updateSelectionState();
            let cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
            if (!cloudFolha) {
                const width = 21 * CM_TO_PX;
                const height = 29.7 * CM_TO_PX;
                cloudFolha = new fabric.Rect({
                    id: 'CloudFolha',
                    left: (canvas.width - width) / 2,
                    top: (canvas.height - height) / 2,
                    width: width,
                    height: height,
                    fill: 'white',
                    selectable: false,
                    evented: false,
                    excludeFromExport: true
                });
                canvas.add(cloudFolha);
            }
            cloudFolha.set({
                selectable: false,
                evented: false,
                excludeFromExport: true
            });
            canvas.sendToBack(cloudFolha);
            canvasState.isUndoOrRedoing = false;
        });
        ensureCloudFolhaAtBottom();
    }
}

// Função para refazer a última ação desfeita
function redo() {
    if (canvasState.redoStack.length > 0) {
        canvasState.isUndoOrRedoing = true;
        const currentState = JSON.stringify(canvas.toJSON(['id']));
        canvasState.undoStack.push(currentState);
        const nextState = JSON.parse(canvasState.redoStack.pop());
        const pattern = canvas.backgroundImage || canvas.backgroundColor;
        canvas.clear();
        canvas.loadFromJSON(nextState, () => {
            canvas.setBackgroundColor(pattern, canvas.renderAll.bind(canvas));
            canvas.renderAll();
            updateSelectionState();
            let cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
            if (!cloudFolha) {
                const width = 21 * CM_TO_PX;
                const height = 29.7 * CM_TO_PX;
                cloudFolha = new fabric.Rect({
                    id: 'CloudFolha',
                    left: (canvas.width - width) / 2,
                    top: (canvas.height - height) / 2,
                    width: width,
                    height: height,
                    fill: 'white',
                    selectable: false,
                    evented: false,
                    excludeFromExport: true
                });
                canvas.add(cloudFolha);
            }
            cloudFolha.set({
                selectable: false,
                evented: false,
                excludeFromExport: true
            });
            canvas.sendToBack(cloudFolha);
            canvasState.isUndoOrRedoing = false;
        });
    }
}

function ensureCloudFolhaAtBottom() {
    const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
    if (cloudFolha) {
        canvas.sendToBack(cloudFolha);
        canvas.requestRenderAll();
    }
}

function updateSelectionState() {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        activeObject.setCoords();
    }
}


//--------------------------------- Seção Inicio Tamanho do Documento ---------------------------------

document.getElementById('docSizeBtn').addEventListener('click', () => {
  const modal = document.getElementById('docSizeModal');
  modal.style.display = 'flex';
});

document.getElementById('closeDocSizeModal').addEventListener('click', () => {
  const modal = document.getElementById('docSizeModal');
  modal.style.display = 'none';
});

document.getElementById('closeDocSizeModalBtn').addEventListener('click', () => {
  const modal = document.getElementById('docSizeModal');
  modal.style.display = 'none';
});

document.getElementById('setA4Vertical').addEventListener('click', () => {
  docWidthInput.value = 21;
  docHeightInput.value = 29.7;
});

document.getElementById('setA4Horizontal').addEventListener('click', () => {
  docWidthInput.value = 29.7;
  docHeightInput.value = 21;
});

//--------------------------------- Seção Final Tamanho do Documento ---------------------------------

//--------------------------------- Seção Atalhos ---------------------------------

let lastRemovedState = null;

document.addEventListener('keydown', function (e) {
    const activeObject = canvas.getActiveObject();

    if (activeObject && activeObject.isEditing) {
        return;
    }

    if (e.key === 'Delete') {
        const activeObjects = canvas.getActiveObjects();
        if (activeObjects && activeObjects.length) {
            activeObjects.forEach(obj => {
                if (obj.id !== 'CloudFolha') {
                    canvas.remove(obj);
                }
            });
            canvas.discardActiveObject();
            canvas.requestRenderAll();
        }
    }

    // Duplicar (Ctrl + D)
    if (e.ctrlKey && e.key === 'd') {
        e.preventDefault();
        const activeObjects = canvas.getActiveObjects();
        if (activeObjects && activeObjects.length) {
            const clones = [];
            activeObjects.forEach(obj => {
                if (obj.id !== 'CloudFolha') {
                    const clone = fabric.util.object.clone(obj);
                    clone.set({
                        left: obj.left + 20,
                        top: obj.top + 20
                    });
                    canvas.add(clone);
                    clones.push(clone);
                }
            });
            canvas.discardActiveObject();
            if (clones.length > 1) {
                const selection = new fabric.ActiveSelection(clones, {
                    canvas
                });
                canvas.setActiveObject(selection);
            } else if (clones.length === 1) {
                canvas.setActiveObject(clones[0]);
            }
            canvas.requestRenderAll();
        }
    }

    // Copiar (Ctrl + C)
    if (e.ctrlKey && e.key === 'c') {
        e.preventDefault();
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'image') {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = activeObject.width * activeObject.scaleX;
            tempCanvas.height = activeObject.height * activeObject.scaleY;
            const tempFabricCanvas = new fabric.Canvas(tempCanvas);
            const clone = fabric.util.object.clone(activeObject);
            clone.left = 0;
            clone.top = 0;
            tempFabricCanvas.add(clone);
            tempFabricCanvas.renderAll();
            tempCanvas.toBlob(blob => {
                const item = new ClipboardItem({
                    'image/png': blob
                });
                navigator.clipboard.write([item]).then(() => {
                    showCustomAlert('Imagem copiada para área de transferência!');
                });
            });
        }
    }

    // Selecionar Tudo (Ctrl + A)
    if (e.ctrlKey && e.key === 'a') {
        e.preventDefault();
        const objects = canvas.getObjects().filter(obj => obj.id !== 'CloudFolha');
        if (objects.length > 0) {
            const selection = new fabric.ActiveSelection(objects, {
                canvas
            });
            canvas.setActiveObject(selection);
            canvas.requestRenderAll();
        }
    }
});
document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && e.key === 'v') {
        e.preventDefault();
        navigator.clipboard.read().then(data => {
            data.forEach(item => {
                if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                    item.getType('image/png').then(blob => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            fabric.Image.fromURL(e.target.result, function (img) {
                                const pageWidth = 21 * CM_TO_PX;
                                const pageHeight = 29.7 * CM_TO_PX;
                                const scale = Math.min(pageWidth * 0.8 / img.width, pageHeight * 0.8 / img.height);
                                img.scale(scale);
                                const a4Page = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
                                if (a4Page) {
                                    img.set({
                                        left: a4Page.left + (a4Page.width - img.width * scale) / 2,
                                        top: a4Page.top + (a4Page.height - img.height * scale) / 2
                                    });
                                }
                                canvas.add(img);
                                canvas.setActiveObject(img);
                                canvas.renderAll();

                                // Notificação personalizada
                                showCustomAlert('Imagem colada com sucesso!');
                            });
                        };
                        reader.readAsDataURL(blob);
                    });
                }
                if (item.types.includes('text/plain')) {
                    item.getType('text/plain').then(blob => {
                        blob.text().then(text => {
                            const itext = new fabric.IText(text, {
                                left: 100,
                                top: 100,
                                fontFamily: 'Arial',
                                fontSize: 20,
                                fill: 'black'
                            });
                            canvas.add(itext);
                            canvas.setActiveObject(itext);
                            canvas.renderAll();

                            // Notificação personalizada
                            showCustomAlert('Texto colado com sucesso!');
                        });
                    });
                }
            });
        }).catch(error => {
            console.error('Erro ao colar:', error);
            showCustomAlert('Erro ao colar. Verifique se há algo na área de transferência.');
        });
    }
});

// Adiciona os atalhos
document.addEventListener('keydown', function (e) {
    // F2: Adiciona as guias padrão
    if (e.key === 'F2') {
        e.preventDefault();
        document.getElementById('addDefaultGuidesBtn').click();
    }

    // Shift + F2: Apaga as guias padrão
    if (e.shiftKey && e.key === 'F2') {
        e.preventDefault();
        document.getElementById('removeGuidesBtn').click();
    }

    // Ctrl + O: Abrir Documento
    if (e.ctrlKey && e.key === 'o') {
        e.preventDefault();
        document.getElementById('openDocumentBtn').click();
    }

    // Ctrl + S: Salvar Documento
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('saveDocumentBtn').click();
    }

    // Ctrl + E: Modal flutuante exportar
    if (e.ctrlKey && e.key === 'e') {
        e.preventDefault();
        document.getElementById('saveAsBtn').click();
    }
});

document.addEventListener('keydown', function (e) {
    // Verifica se a edição de texto está ativa
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.isEditing) {
        return; // Sai da função se estiver editando texto
    }

    // Previne o comportamento padrão para evitar conflitos com atalhos do navegador
    if (e.ctrlKey || e.metaKey) { // Ctrl (Windows) ou Command (Mac)
        switch (e.key.toLowerCase()) {
            case 'c': // Ctrl + C (Copiar)
            case 'v': // Ctrl + V (Colar)
            case 'x': // Ctrl + X (Recortar)
            case 'z': // Ctrl + Z (Desfazer)
            case 'y': // Ctrl + Y (Refazer)
                e.preventDefault(); // Previne o comportamento padrão
                break;
        }
    }

    // Mapeia as teclas para os botões do menu esquerdo
    switch (e.key.toLowerCase()) {
        case 'c': // Recortar
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('cropImageBtn').click();
            break;
        case 'v': // Mover (não faz nada)
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('moveBtn').click();
            break;
        case 'g': // Balde
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('btnBalde').click();
            break;
        case 'b': // Pincel
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('btnPincel').click();
            break;
        case 'e': // Borracha
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('btnBorracha').click();
            break;
        case 'w': // Remover cor clique
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('removeCorCliqueBtn').click();
            break;
        case 'm': // Selecionar
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('selectBtn').click();
            break;
        case 't': // Texto
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('textoBtn').click();
            break;
        case 'i': // Importar imagem
            e.preventDefault(); // Previne o comportamento padrão
            document.getElementById('loadImageBtn').click();
            break;
    }
});

// ----------------------------------------- Seção Inicio Impressão ---------------------------------

async function printCanvas() {
    const dpi = parseInt(document.getElementById('resolutionInput').value) || 150;
    const scale = dpi / 96;

    const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
    if (!cloudFolha) {
        showCustomAlert('Nenhuma folha encontrada.');
        return;
    }

    const tempContainer = document.createElement('div');
    document.body.appendChild(tempContainer);

    const exportCanvas = document.createElement('canvas');
    const targetWidth = cloudFolha.width * scale;
    const targetHeight = cloudFolha.height * scale;

    exportCanvas.width = targetWidth;
    exportCanvas.height = targetHeight;
    tempContainer.appendChild(exportCanvas);

    const exportFabricCanvas = new fabric.Canvas(exportCanvas, {
        enableRetinaScaling: true,
        imageSmoothingQuality: 'high'
    });

    exportFabricCanvas.setWidth(targetWidth);
    exportFabricCanvas.setHeight(targetHeight);

    const whiteBackground = new fabric.Rect({
        width: cloudFolha.width,
        height: cloudFolha.height,
        fill: 'white',
        originX: 'left',
        originY: 'top',
        scaleX: scale,
        scaleY: scale
    });
    exportFabricCanvas.add(whiteBackground);

    const objects = canvas.getObjects().filter(obj => obj.id !== 'CloudFolha');
    const promises = objects.map(async (obj) => {
        const clonedObj = await cloneObjectWithQuality(obj);

        // Ajusta a posição e a escala para a rotação
        const angle = obj.angle || 0;
        const radians = fabric.util.degreesToRadians(angle);
        const cos = Math.abs(Math.cos(radians));
        const sin = Math.abs(Math.sin(radians));

        const scaledWidth = (obj.width * obj.scaleX * cos + obj.height * obj.scaleY * sin) * scale;
        const scaledHeight = (obj.height * obj.scaleY * cos + obj.width * obj.scaleX * sin) * scale;

        const relativeLeft = (obj.left - cloudFolha.left) / cloudFolha.scaleX;
        const relativeTop = (obj.top - cloudFolha.top) / cloudFolha.scaleY;

        const scaleFactor = targetWidth / cloudFolha.width;

        clonedObj.set({
            left: relativeLeft * scaleFactor,
            top: relativeTop * scaleFactor,
            scaleX: (obj.scaleX / cloudFolha.scaleX) * scaleFactor,
            scaleY: (obj.scaleY / cloudFolha.scaleY) * scaleFactor,
            angle: angle // Mantém o ângulo de rotação
        });

        return clonedObj;
    });

    const clonedObjects = await Promise.all(promises);
    clonedObjects.forEach(obj => exportFabricCanvas.add(obj));

    exportFabricCanvas.renderAll();

    const dataUrl = exportFabricCanvas.toDataURL({
        format: 'png',
        quality: 1.0,
        enableRetinaScaling: true,
        multiplier: 1,
        imageSmoothingEnabled: true,
        imageSmoothingQuality: 'high'
    });

    const printWindow = window.open('');
    printWindow.document.write(`
        <html>
            <head>
                <title>Imprimir</title>
                <style>
                    @media print {
                        @page {
                            size: auto;
                            margin: 0;
                        }
                        body {
                            margin: 0;
                            padding: 0;
                        }
                        img {
                            width: 100%;
                            height: auto;
                            display: block;
                        }
                    }
                </style>
            </head>
            <body>
                <img src="${dataUrl}" onload="window.print();window.close()">
            </body>
        </html>
    `);
    printWindow.document.close();

    tempContainer.remove();
    exportFabricCanvas.dispose();
}

async function cloneObjectWithQuality(obj) {
    return new Promise((resolve) => {
        if (obj.type === 'image') {
            const imgElement = obj.getElement();
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = imgElement.width;
            tempCanvas.height = imgElement.height;
            const ctx = tempCanvas.getContext('2d');
            ctx.drawImage(imgElement, 0, 0);
            const dataUrl = tempCanvas.toDataURL('image/png', 1.0);

            fabric.Image.fromURL(dataUrl, (img) => {
                resolve(img);
            });
        } else {
            resolve(fabric.util.object.clone(obj));
        }
    });
}

document.addEventListener('keydown', function (e) {
    if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        printCanvas();
    }
});

// ----------------------------------------- Seção Fim Impressão ---------------------------------

// ----------------------------------------- Seção Inicio Mover com Setas do teclado ---------------------------------

let arrowKeys = {
    ArrowUp: false,
    ArrowDown: false,
    ArrowLeft: false,
    ArrowRight: false
};

let moveSpeed = 0.1;
const fastSpeed = 0.5;
const maxSpeed = 1;
const speedIncrement = 0.05;

let keyPressTime = 0;
let isKeyPressed = false;

function moveSelectedObjects(dx, dy) {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects && activeObjects.length > 0) {
        activeObjects.forEach(obj => {
            if (obj.id !== 'CloudFolha') {
                obj.set({
                    left: obj.left + dx,
                    top: obj.top + dy
                });
                obj.setCoords();
            }
        });
        canvas.renderAll();
    }
}

function handleArrowKeys() {
    if (isKeyPressed) {
        keyPressTime += 0.1;
        if (keyPressTime > 5) {
            keyPressTime = 5;
        }
        if (keyPressTime > 5) {
            moveSpeed = fastSpeed;
        }
        if (moveSpeed < maxSpeed) {
            moveSpeed += speedIncrement;
        }
    }

    if (arrowKeys.ArrowUp) {
        moveSelectedObjects(0, -moveSpeed);
    }
    if (arrowKeys.ArrowDown) {
        moveSelectedObjects(0, moveSpeed);
    }
    if (arrowKeys.ArrowLeft) {
        moveSelectedObjects(-moveSpeed, 0);
    }
    if (arrowKeys.ArrowRight) {
        moveSelectedObjects(moveSpeed, 0);
    }

    requestAnimationFrame(handleArrowKeys); 
}

handleArrowKeys();

document.addEventListener('keydown', function (e) {
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        if (!arrowKeys[e.key]) {
            arrowKeys[e.key] = true;
            isKeyPressed = true;  
            keyPressTime = 0;  
            e.preventDefault();  
        }
    }
});

document.addEventListener('keyup', function (e) {
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        arrowKeys[e.key] = false;
        isKeyPressed = false;  
        moveSpeed = 0.1;  
        keyPressTime = 0;  
    }
});

// ----------------------------------------- Seção Fim Mover com Setas do teclado --------------------------------- 

// ----------------------------------------- Seção Fim Mover zoom espaço do teclado --------------------------------- 

// Variável para controlar se o espaço está pressionado
let isSpacePressed = false;

// Variável para controlar se o canvas está sendo arrastado
let isDraggingCanvas = false;
let lastPosX = 0;
let lastPosY = 0;

// Função para ativar o arrasto do canvas
function startDraggingCanvas(e) {
    if (isSpacePressed && !isDraggingCanvas) {
        isDraggingCanvas = true;
        lastPosX = e.clientX;
        lastPosY = e.clientY;
        canvas.defaultCursor = 'grabbing';
        canvas.renderAll();
    }
}

// Função para mover o canvas
function dragCanvas(e) {
    if (isDraggingCanvas) {
        const deltaX = e.clientX - lastPosX;
        const deltaY = e.clientY - lastPosY;

        // Move o viewport do canvas
        const vpt = canvas.viewportTransform;
        vpt[4] += deltaX;
        vpt[5] += deltaY;

        canvas.requestRenderAll();

        lastPosX = e.clientX;
        lastPosY = e.clientY;
    }
}

// Função para parar o arrasto do canvas
function stopDraggingCanvas() {
    if (isDraggingCanvas) {
        isDraggingCanvas = false;
        canvas.defaultCursor = isSpacePressed ? 'grab' : 'default';
        canvas.renderAll();
    }
}

// Evento para detectar quando o espaço é pressionado
document.addEventListener('keydown', function (e) {
    if (e.code === 'Space' && !isSpacePressed) {
        isSpacePressed = true;

        // Verifica se um objeto de texto não está em modo de edição
        const activeObject = canvas.getActiveObject();
        if (!activeObject || (activeObject.type !== 'i-text' && activeObject.type !== 'text')) {
            canvas.defaultCursor = 'grab';
            canvas.renderAll();
        }
    }
});

// Evento para detectar quando o espaço é solto
document.addEventListener('keyup', function (e) {
    if (e.code === 'Space' && isSpacePressed) {
        isSpacePressed = false;
        canvas.defaultCursor = 'default';
        canvas.renderAll();
    }
});

// Evento para iniciar o arrasto do canvas
canvas.on('mouse:down', function (e) {
    if (isSpacePressed) {
        startDraggingCanvas(e.e);
    }
});

// Evento para mover o canvas enquanto arrasta
canvas.on('mouse:move', function (e) {
    if (isDraggingCanvas) {
        dragCanvas(e.e);
    }
});

// Evento para parar o arrasto do canvas
canvas.on('mouse:up', function () {
    stopDraggingCanvas();
});

// Evento para desativar o arrasto do canvas quando um objeto de texto está em edição
canvas.on('text:editing:entered', function () {
    isSpacePressed = false;
    canvas.defaultCursor = 'text';
    canvas.renderAll();
});

// Evento para reativar o arrasto do canvas quando a edição de texto termina
canvas.on('text:editing:exited', function () {
    if (isSpacePressed) {
        canvas.defaultCursor = 'grab';
    } else {
        canvas.defaultCursor = 'default';
    }
    canvas.renderAll();
});

// ----------------------------------------- Seção Fim Mover zoom espaço do teclado  --------------------------------- 


// ----------------------------------------- Seção Inicio Texto ---------------------------------

document.getElementById('newLayerBtn').addEventListener('click', () => {
    const rect = new fabric.Rect({
        left: canvas.width / 2,
        top: canvas.height / 2,
        width: 100,
        height: 100,
        fill: '#ffffff',
        originX: 'center',
        originY: 'center'
    });
    canvas.add(rect);
    canvas.setActiveObject(rect);
    saveState();
});

document.getElementById('deleteLayerBtn').addEventListener('click', () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        canvas.remove(activeObject);
        canvas.discardActiveObject();
        saveState();
    }
});

document.getElementById('centerLayerBtn').addEventListener('click', () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
        if (cloudFolha) {
            activeObject.set({
                left: cloudFolha.left + cloudFolha.width * cloudFolha.scaleX / 2,
                top: cloudFolha.top + cloudFolha.height * cloudFolha.scaleY / 2
            });
            canvas.renderAll();
            saveState();
        }
    }
});

updateLayersList();

function getLayerName(obj, index) {
    if (obj.type === 'i-text') {
        return obj.text.substring(0, 10) || `Texto ${index + 1}`;
    } else if (obj.type === 'image') {
        return obj.name || obj._element?.currentSrc?.split('/').pop() || `Imagem ${index + 1}`;
    } else {
        return `${obj.type} ${index + 1}`;
    }
}

canvas.on('mouse:down', function (e) {
    if (e.target) {
        canvas.setActiveObject(e.target);
        updateLayersList();
    }
});

document.getElementById('layersList').addEventListener('click', function (e) {
    const target = e.target;
    if (target.tagName === 'LI') {
        const index = parseInt(target.getAttribute('data-index'));
        const objects = canvas.getObjects().filter(obj => obj.id !== 'CloudFolha');
        const selectedObject = objects[objects.length - 1 - index];

        canvas.setActiveObject(selectedObject);
        canvas.renderAll();

        updateLayersList();
    }
});

function updateLayersList() {
    const layersList = document.getElementById('layersList');
    layersList.innerHTML = '';

    const objects = canvas.getObjects().filter(obj => !obj.excludeFromLayers && obj.id !== 'CloudFolha');
    const reversedObjects = objects.reverse();

    reversedObjects.forEach((obj, index) => {
        const layer = document.createElement('li');
        layer.setAttribute('data-index', index);
        layer.textContent = getLayerName(obj, index);

        if (obj === canvas.getActiveObject()) {
            layer.classList.add('selected');
        }

        layer.draggable = true;

        layer.addEventListener('dragstart', (e) => {
            draggedItem = layer;
            originalIndex = index;
            e.dataTransfer.effectAllowed = 'move';
            layer.classList.add('dragging');
        });

        layer.addEventListener('dragenter', (e) => {
            e.preventDefault();
            if (layer !== draggedItem) {
                const rect = layer.getBoundingClientRect();
                const mouseY = e.clientY;
                const threshold = rect.top + rect.height / 2;

                layer.classList.remove('drop-above', 'drop-below');

                if (mouseY < threshold) {
                    layer.classList.add('drop-above');
                } else {
                    layer.classList.add('drop-below');
                }
            }
        });

        layer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });

        layer.addEventListener('dragleave', () => {
            layer.classList.remove('drop-above', 'drop-below');
        });

        layer.addEventListener('drop', handleDropLayer);

        layer.addEventListener('dragend', () => {
            document.querySelectorAll('#layersList li').forEach(item => {
                item.classList.remove('drop-above', 'drop-below', 'dragging');
            });
            draggedItem = null;
            originalIndex = null;
        });

        layersList.appendChild(layer);
    });
}

function handleDropLayer(e) {
    e.preventDefault();
    e.stopPropagation();

    if (!draggedItem) return;

    const rect = e.currentTarget.getBoundingClientRect();
    const mouseY = e.clientY;
    const threshold = rect.top + rect.height / 2;
    const dropAbove = mouseY < threshold;

    const fromIndex = originalIndex;
    const toIndex = parseInt(e.currentTarget.getAttribute('data-index')); 

    const objects = canvas.getObjects().filter(obj => obj.id !== 'CloudFolha');
    const reversedObjects = objects.reverse();

    const movedObject = reversedObjects[fromIndex];

    let finalIndex = dropAbove ? toIndex : toIndex + 1;
    if (fromIndex < toIndex) finalIndex--;

    canvas.remove(movedObject);
    canvas.insertAt(movedObject, objects.length - finalIndex - 1);

    const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
    if (cloudFolha) {
        canvas.sendToBack(cloudFolha);
    }

    document.querySelectorAll('#layersList li').forEach(item => {
        item.classList.remove('drop-above', 'drop-below');
    });

    updateLayersList();
    saveState();
    draggedItem = null;
    originalIndex = null;
}

// ----------------------------------------- Seção Final Texto ---------------------------------
const toolButtons = document.querySelectorAll('.tool-button:not(#loadImageBtn)');
let currentTool = 'move';
toolButtons.forEach(button => {
  button.addEventListener('click', function () {
    toolButtons.forEach(btn => btn.classList.remove('selected'));
    this.classList.add('selected');
    currentTool = this.id.replace('Btn', '').toLowerCase();
    if (currentTool === 'move') {
      canvas.selection = true;
      canvas.defaultCursor = 'default';
      canvas.hoverCursor = 'move';
      canvas.getObjects().forEach(obj => {
        if (obj.id !== 'CloudFolha') {
          obj.selectable = true;
          obj.evented = true;
        }
      });
    } else if (currentTool === 'select') {
      canvas.selection = true;
      canvas.defaultCursor = 'crosshair';
      canvas.hoverCursor = 'crosshair';
    } else if (currentTool === 'texto') {
      addText();
    }
  });
});

canvas.selection = true;
canvas.defaultCursor = 'default';
canvas.hoverCursor = 'move';

const patternCanvas = document.createElement('canvas');
patternCanvas.width = 20;
patternCanvas.height = 20;
const ctx = patternCanvas.getContext('2d');
ctx.fillStyle = '#16213e';
ctx.fillRect(0, 0, patternCanvas.width, patternCanvas.height);
ctx.fillStyle = '#1f2b4c';
ctx.beginPath();
ctx.arc(10, 10, 3, 0, Math.PI * 2);
ctx.fill();
const pattern = new fabric.Pattern({
  source: patternCanvas,
  repeat: 'repeat'
});

canvas.setBackgroundColor(pattern, canvas.renderAll.bind(canvas));



document.getElementById('loadImageBtn').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', function (e) {
  const files = Array.from(e.target.files);
  if (files.length > 0) {
    let loadedImages = 0;
    const totalImages = files.length;
    const spacing = 50;
    files.forEach((file, index) => {
      const reader = new FileReader();
      reader.onload = function (f) {
        const data = f.target.result;
        fabric.Image.fromURL(data, function (img) {
          const pageWidth = 21 * CM_TO_PX;
          const pageHeight = 29.7 * CM_TO_PX;
          const scale = Math.min(pageWidth * 0.8 / img.width, pageHeight * 0.8 / img.height);
          img.scale(scale);
          const a4Page = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
          if (a4Page) {
            img.set({
              left: a4Page.left + (a4Page.width - img.width * scale) / 2 + index * spacing,
              top: a4Page.top + (a4Page.height - img.height * scale) / 2 + index * spacing
            });
          }
          canvas.add(img);
          canvas.setActiveObject(img);
          updateSizeInputs();
          loadedImages++;
          if (loadedImages === totalImages) {
            canvas.renderAll();
          }
        });
      };
      reader.readAsDataURL(file);
    });
  }
});

function updateOpacityControls() {
  const activeObjects = canvas.getActiveObjects();
  const opacityControls = document.getElementById('opacity-controls');
  const opacityInput = document.getElementById('opacity-input');

  if (activeObjects.length > 0 && activeObjects.every(obj => obj.type === 'image')) {
    opacityControls.style.display = 'flex';
    opacityInput.value = Math.round(activeObjects[0].opacity * 100);
    activeObjects.forEach(obj => obj.set('opacity', 1.0));
  } else {
    opacityControls.style.display = 'none';
  }
}

function exportSelectedAsPNG() {
  const activeObject = canvas.getActiveObject();
  if (!activeObject) return;
  const tempCanvas = document.createElement('canvas');
  const ctx = tempCanvas.getContext('2d');
  if (activeObject.type === 'activeSelection') {
    const group = activeObject;
    const groupBounds = group.getBoundingRect();
    tempCanvas.width = groupBounds.width;
    tempCanvas.height = groupBounds.height;
    const tempFabricCanvas = new fabric.Canvas(tempCanvas);
    const objects = group.getObjects();
    objects.forEach(obj => {
      const clone = fabric.util.object.clone(obj);
      clone.left -= groupBounds.left;
      clone.top -= groupBounds.top;
      tempFabricCanvas.add(clone);
    });
    tempFabricCanvas.renderAll();
    const dataURL = tempFabricCanvas.toDataURL({
      format: 'png',
      quality: 1
    });
    downloadImage(dataURL, 'merged_selection.png');
    tempFabricCanvas.dispose();
  } else {
    tempCanvas.width = activeObject.width * activeObject.scaleX;
    tempCanvas.height = activeObject.height * activeObject.scaleY;
    const tempFabricCanvas = new fabric.Canvas(tempCanvas);
    const clone = fabric.util.object.clone(activeObject);
    clone.left = 0;
    clone.top = 0;
    tempFabricCanvas.add(clone);
    tempFabricCanvas.renderAll();
    const dataURL = tempFabricCanvas.toDataURL({
      format: 'png',
      quality: 1
    });
    downloadImage(dataURL, 'selection.png');
    tempFabricCanvas.dispose();
  }
}

function downloadImage(dataURL, filename) {
  const link = document.createElement('a');
  link.download = filename;
  link.href = dataURL;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

document.getElementById('opacity-input').addEventListener('input', function (e) {
  const activeObjects = canvas.getActiveObjects();
  if (activeObjects.length > 0 && activeObjects.every(obj => obj.type === 'image')) {
    const opacity = parseInt(e.target.value) / 100;
    activeObjects.forEach(obj => obj.set('opacity', opacity));
    canvas.renderAll();
  }
});

document.getElementById('export-png-btn').addEventListener('click', exportSelectedAsPNG);



lockRatioBtn.addEventListener('click', () => {
  isRatioLocked = !isRatioLocked;
  lockRatioBtn.textContent = isRatioLocked ? '🔒' : '🔓';

  const activeObject = canvas.getActiveObject();
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

  if (isRatioLocked) {
    if (activeObject && activeObject.id !== 'CloudFolha') {
      if (activeObject.type === 'i-text') {
        const scaledWidth = activeObject.width * activeObject.scaleX;
        const scaledHeight = activeObject.height * activeObject.scaleY;
        aspectRatio = scaledWidth / scaledHeight;
      } else {
        aspectRatio = (activeObject.width * activeObject.scaleX) / (activeObject.height * activeObject.scaleY);
      }
    } else if (cloudFolha) {
      aspectRatio = cloudFolha.width / cloudFolha.height;
    }
  }
});

docSwapDimsBtn.addEventListener('click', () => {
  const currentWidth = docWidthInput.value;
  const currentHeight = docHeightInput.value;
  docWidthInput.value = currentHeight;
  docHeightInput.value = currentWidth;
});

function updateDocDimension(input, dimension) {
  if (!docIsRatioLocked) return;
  const value = parseFloat(input.value);
  if (dimension === 'width') {
    const newHeight = value / docAspectRatio;
    docHeightInput.value = newHeight.toFixed(1);
  } else {
    const newWidth = value * docAspectRatio;
    docWidthInput.value = newWidth.toFixed(1);
  }
}

docWidthInput.addEventListener('input', () => updateDocDimension(docWidthInput, 'width'));
docHeightInput.addEventListener('input', () => updateDocDimension(docHeightInput, 'height'));

docSizeOkBtn.addEventListener('click', () => {
  const width = parseFloat(docWidthInput.value) * CM_TO_PX;
  const height = parseFloat(docHeightInput.value) * CM_TO_PX;
  const existingFolha = canvas.getObjects().filter(obj => obj.id === 'CloudFolha');
  existingFolha.forEach(obj => canvas.remove(obj));
  const a4Page = new fabric.Rect({
    id: 'CloudFolha',
    left: (canvas.width - width) / 2,
    top: (canvas.height - height) / 2,
    width: width,
    height: height,
    fill: 'white',
    selectable: false,
    evented: false
  });
  canvas.add(a4Page);
  canvas.sendToBack(a4Page);
  canvas.renderAll();
});


function updateFloatingTextMenu() {
  const activeObject = canvas.getActiveObject();
  const menu = document.getElementById('floating-text-menu');

  if (activeObject && activeObject.type === 'i-text') {
    const zoom = canvas.getZoom();
    const objRect = activeObject.getBoundingRect();
    const canvasRect = canvas.getElement().getBoundingClientRect();

    let left = canvasRect.left + objRect.left + objRect.width + 10;
    let top = canvasRect.top + objRect.top;

    const menuWidth = 200;
    const menuHeight = 210;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;

    if (left + menuWidth > windowWidth) {
      left = canvasRect.left + objRect.left - menuWidth - 10;
    }
    if (top + menuHeight > windowHeight) {
      top = windowHeight - menuHeight - 10;
    }

    menu.style.left = `${left}px`;
    menu.style.top = `${top}px`;
    menu.style.display = 'block';

    const fontSizeInput = menu.querySelector('#font-size');
    const outlineSize = menu.querySelector('.outline-size');
    const outlineColor = menu.querySelector('.outline-color');
    const gradientCheckbox = menu.querySelector('#gradient-checkbox');
    const gradientColor = menu.querySelector('#gradient-color');

    if (fontSizeInput) {
      const currentFontSize = Math.round(activeObject.fontSize);
      fontSizeInput.value = currentFontSize;
    }

    outlineSize.value = activeObject.strokeWidth ? (activeObject.strokeWidth / 2).toFixed(1) : '0';
    outlineColor.value = activeObject.stroke || '#000000';

 gradientCheckbox.checked = activeObject.fill === 'transparent' ? false : true;
    gradientColor.value = activeObject.fill === 'transparent' ? '#ffffff' : activeObject.fill;
  } else {
    menu.style.display = 'none';
  }
}

document.querySelectorAll('.outline-row input').forEach(input => {
  input.addEventListener('input', function () {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      applyOutlineToText(activeObject);
    }
  });
  input.addEventListener('change', function () {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'i-text') {
      applyOutlineToText(activeObject);
    }
  });
});

function applyOutlineToText(textObject) {
  const outlineRow = document.querySelector('.outline-row');
  const size = parseFloat(outlineRow.querySelector('.outline-size').value);
  const color = outlineRow.querySelector('.outline-color').value;
  textObject.set({
    paintFirst: 'stroke',
    stroke: color,
    strokeWidth: size * 2,
    strokeUniform: true,
    strokeLineJoin: 'round'
  });
  canvas.requestRenderAll();
}


document.addEventListener('click', function (e) {
  const menu = document.getElementById('floating-text-menu');
  const activeObject = canvas.getActiveObject();
  if (!menu.contains(e.target) && (!activeObject || activeObject.type !== 'i-text')) {
    menu.style.display = 'none';
  }
});

document.getElementById('font-family').addEventListener('change', function (e) {
  const activeObject = canvas.getActiveObject();
  if (activeObject && activeObject.type === 'i-text') {
    activeObject.set('fontFamily', e.target.value);
    canvas.renderAll();
  }
});

document.getElementById('font-size').addEventListener('input', function (e) {
  const activeObject = canvas.getActiveObject();
  if (activeObject && activeObject.type === 'i-text') {
    const newFontSize = parseInt(e.target.value);

    activeObject.set({
      fontSize: newFontSize,
      scaleX: 1,
      scaleY: 1
    });

    const widthCm = convertDimensions(activeObject.width, 'px', 'cm');
    const heightCm = convertDimensions(activeObject.height, 'px', 'cm');
    widthInput.value = widthCm.toFixed(1);
    heightInput.value = heightCm.toFixed(1);

    canvas.renderAll();
  }
});

document.getElementById('font-color').addEventListener('input', function (e) {
  const activeObject = canvas.getActiveObject();
  if (activeObject && activeObject.type === 'i-text') {
    activeObject.set('fill', e.target.value);
    canvas.renderAll();
  }
});

document.getElementById('text-align').addEventListener('change', function (e) {
  const activeObject = canvas.getActiveObject();
  if (activeObject && activeObject.type === 'i-text') {
    activeObject.set('textAlign', e.target.value);
    canvas.renderAll();
  }
});

document.getElementById('floating-text-menu').addEventListener('click', function (e) {
  e.stopPropagation();
});

function addText() {
  const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
  if (!cloudFolha) return;

  const text = new fabric.IText('Digite seu texto', {
    left: cloudFolha.left + cloudFolha.width / 2,
    top: cloudFolha.top + cloudFolha.height / 2,
    fontFamily: 'Arial',
    fontSize: 20,
    fill: '#000000',
    originX: 'center',
    originY: 'center',
    textAlign: 'center',
    stroke: null,
    strokeWidth: 0
  });

  canvas.add(text);
  canvas.setActiveObject(text);
  canvas.renderAll();
}

document.getElementById('gradient-checkbox').addEventListener('change', function (e) {
  const activeObject = canvas.getActiveObject();
  if (activeObject && activeObject.type === 'i-text') {
    const gradientColor = document.getElementById('gradient-color').value;
    const primaryColor = document.getElementById('font-color').value;

    if (e.target.checked) {
      activeObject.set('fill', new fabric.Gradient({
        type: 'linear',
        coords: { x1: 0, y1: 0, x2: activeObject.width, y2: 0 },
        colorStops: [
          { offset: 0, color: primaryColor },
          { offset: 0.5, color: gradientColor }
        ]
      }));
    } else {
      activeObject.set('fill', primaryColor);
    }
    canvas.renderAll();
  }
});

document.getElementById('gradient-color').addEventListener('input', function (e) {
  const activeObject = canvas.getActiveObject();
  const checkbox = document.getElementById('gradient-checkbox');
  if (activeObject && activeObject.type === 'i-text' && checkbox.checked) {
    const primaryColor = document.getElementById('font-color').value;
    activeObject.set('fill', new fabric.Gradient({
      type: 'linear',
      coords: { x1: 0, y1: 0, x2: activeObject.width, y2: 0 },
      colorStops: [
        { offset: 0, color: primaryColor },
        { offset: 0.5, color: e.target.value }
      ]
    }));
    canvas.renderAll();
  }
});



//--------------------------------- Seção Final Texto ---------------------------------

// ----------------------------------------- Seção Inicio Menu Imagem ----------------------------------------------------

document.getElementById('rotateBtn').addEventListener('click', () => {
    const activeObject = canvas.getActiveObject();
    const rotateInput = document.getElementById('rotateInput');
    if (activeObject) {
        const rotationValue = parseInt(rotateInput.value);
        activeObject.rotate((activeObject.angle + rotationValue) % 360);
        canvas.renderAll();
        saveState();
    } else {
        showCustomAlert('Selecione um objeto para girar.');
    }
});

document.getElementById('duplicateBtn').addEventListener('click', () => {
    const activeObject = canvas.getActiveObject();
    const duplicateInput = document.getElementById('duplicateInput');
    const duplicateCount = parseInt(duplicateInput.value);
    if (activeObject && duplicateCount > 0) {
        for (let i = 0; i < duplicateCount; i++) {
            const clone = fabric.util.object.clone(activeObject);
            clone.set({
                left: activeObject.left + (i + 1) * 10,
                top: activeObject.top + (i % 2) * 10 
            });
            canvas.add(clone);
        }
        canvas.renderAll();
        saveState();
    } else {
        showCustomAlert('Selecione um objeto para duplicar e insira um número válido.');
    }
});

document.getElementById('organizeBtn').addEventListener('click', () => {
    const selectedObjects = canvas.getActiveObjects();
    const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
    const organizeInput = document.getElementById('organizeInput');
    const spacing = parseFloat(organizeInput.value);
    
    if (selectedObjects.length > 0 && cloudFolha) {
        const cloudFolhaWidth = cloudFolha.width * cloudFolha.scaleX;
        const cloudFolhaHeight = cloudFolha.height * cloudFolha.scaleY;

        let currentX = cloudFolha.left;
        let currentY = cloudFolha.top;

        selectedObjects.forEach((obj, index) => {
            obj.set({
                left: currentX,
                top: currentY
            });

            currentX += obj.width * obj.scaleX + spacing;

            if (currentX > cloudFolha.left + cloudFolhaWidth) {
                currentX = cloudFolha.left;
                currentY += obj.height * obj.scaleY + spacing; 
            }
        });

        canvas.renderAll();
        saveState();
    } else {
        showCustomAlert('Selecione objetos para organizar.');
    }
});

document.getElementById('alignVerticalBtn').addEventListener('click', () => {
    const selectedObjects = canvas.getActiveObjects();
    if (selectedObjects.length > 0) {
        const firstObject = selectedObjects[0];
        const centerY = firstObject.top + (firstObject.height * firstObject.scaleY) / 2;

        selectedObjects.forEach(obj => {
            obj.set({
                top: centerY - (obj.height * obj.scaleY) / 2
            });
        });

        canvas.renderAll();
        saveState();
    } else {
        showCustomAlert('Selecione objetos para alinhar verticalmente.');
    }
});

document.getElementById('alignHorizontalBtn').addEventListener('click', () => {
    const selectedObjects = canvas.getActiveObjects();
    if (selectedObjects.length > 0) {
        const firstObject = selectedObjects[0];
        const centerX = firstObject.left + (firstObject.width * firstObject.scaleX) / 2;

        selectedObjects.forEach(obj => {
            obj.set({
                left: centerX - (obj.width * obj.scaleX) / 2
            });
        });

        canvas.renderAll();
        saveState();
    } else {
        showCustomAlert('Selecione objetos para alinhar horizontalmente.');
    }
});

document.getElementById('flipHorizontalBtn').addEventListener('click', () => {
    const selectedObjects = canvas.getActiveObjects();
    if (selectedObjects.length > 0) {
        selectedObjects.forEach(obj => {
            obj.set({
                scaleX: -obj.scaleX
            });
        });

        canvas.renderAll();
        saveState();
    } else {
        showCustomAlert('Selecione objetos para espelhar horizontalmente.');
    }
});

document.getElementById('flipVerticalBtn').addEventListener('click', () => {
    const activeObjects = canvas.getActiveObjects();
    if (!activeObjects || activeObjects.length === 0) {
        showCustomAlert('Selecione objetos para espelhar verticalmente.');
        return;
    }

    activeObjects.forEach(obj => {
        obj.set('flipY', !obj.flipY);
    });

    canvas.renderAll();
    saveState();
});
// ----------------------------------------- Seção Final Menu Imagem ----------------------------------------------------

// ----------------------------------------- Seção Inicio Menu Editar ----------------------------------------------------

document.getElementById('copyBtn').addEventListener('click', async () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'image') {
        const dataUrl = activeObject.toDataURL(); 
        const blob = await (await fetch(dataUrl)).blob(); 
        const item = new ClipboardItem({ 'image/png': blob });
        await navigator.clipboard.write([item]);
        showCustomAlert('Imagem copiada para a área de transferência.');
    } else {
        showCustomAlert('Selecione uma imagem para copiar.');
    }
});

document.getElementById('pasteBtn').addEventListener('click', async () => {
    try {
        const clipboardItems = await navigator.clipboard.read();
        for (const clipboardItem of clipboardItems) {
            const types = clipboardItem.types;
            for (const type of types) {
                if (type === 'image/png') {
                    const blob = await clipboardItem.getType(type);
                    const imgUrl = URL.createObjectURL(blob);
                    fabric.Image.fromURL(imgUrl, function(img) {
                        img.set({
                            left: 10,
                            top: 10
                        });
                        canvas.add(img);
                        canvas.setActiveObject(img);
                        canvas.renderAll();
                    });
                } else if (type === 'text/plain') {
                    const textBlob = await clipboardItem.getType(type);
                    const text = await textBlob.text();
                    const textObject = new fabric.IText(text, {
                        left: 10,
                        top: 10,
                        fontSize: 20,
                        fill: 'black'
                    });
                    canvas.add(textObject);
                    canvas.setActiveObject(textObject);
                    canvas.renderAll();
                }
            }
        }
    } catch (error) {
        showCustomAlert('Erro ao colar: ' + error.message);
    }
});
// ----------------------------------------- Seção Final Menu Editar ----------------------------------------------------

// ----------------------------------------- Seção Inicio Contorno ----------------------------------------------------
document.getElementById('addContorno').addEventListener('click', function() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || activeObject.type !== 'image') {
        showCustomAlert('Selecione uma imagem para adicionar contorno.');
        return;
    }

    const outlineModal = document.getElementById('outlineModal');
    const outlineImagePreview = document.getElementById('outlineImagePreview');
    
    outlineImagePreview.src = activeObject.toDataURL();
    outlineImagePreview.style.display = 'block';
    outlineImagePreview.style.maxWidth = '80%';
    outlineImagePreview.style.maxHeight = '80vh';
    outlineImagePreview.style.objectFit = 'contain';
    outlineImagePreview.style.margin = 'auto';
    
    outlineModal.style.display = 'flex';
    
    updateSliderValues();
    [outlineSlider1, outlineSlider2, colorPicker1, colorPicker2].forEach(element => {
        element.addEventListener('input', function() {
            applyOutlines();
            updateSliderValues();
        });
    });
});

document.getElementById('closeOutlineModal').addEventListener('click', function() {
    document.getElementById('outlineModal').style.display = 'none';
});

document.getElementById('closeOutlineModal').addEventListener('click', function() {
    document.getElementById('outlineModal').style.display = 'none';
});

document.getElementById('applyOutlineBtn').addEventListener('click', function() {
    const width1 = parseInt(document.getElementById('outlineSlider1').value);
    const width2 = parseInt(document.getElementById('outlineSlider2').value);
    const color1 = document.getElementById('colorPicker1').value;
    const color2 = document.getElementById('colorPicker2').value;
    const activeObject = canvas.getActiveObject();
    
    if (activeObject) {
        const imgElement = activeObject.getElement();

        const maxOutlineWidth = Math.max(width1, width2);
        const padding = maxOutlineWidth;

        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = imgElement.width + (padding * 2); 
        tempCanvas.height = imgElement.height + (padding * 2);

        const offsetX = padding;
        const offsetY = padding;

        const shadows = [];
        if (width1 > 0) {
            shadows.push(
                `drop-shadow(${width1}px 0 0 ${color1})`,
                `drop-shadow(-${width1}px 0 0 ${color1})`,
                `drop-shadow(0 ${width1}px 0 ${color1})`,
                `drop-shadow(0 -${width1}px 0 ${color1})`
            );
        }
        if (width2 > 0) {
            shadows.push(
                `drop-shadow(${width2}px 0 0 ${color2})`,
                `drop-shadow(-${width2}px 0 0 ${color2})`,
                `drop-shadow(0 ${width2}px 0 ${color2})`,
                `drop-shadow(0 -${width2}px 0 ${color2})`
            );
        }

        tempCtx.filter = shadows.join(' ');
        tempCtx.drawImage(imgElement, offsetX, offsetY);

        tempCtx.globalCompositeOperation = 'source-over';
        tempCtx.drawImage(imgElement, offsetX, offsetY);

        const dataUrl = tempCanvas.toDataURL('image/png', 1.0);
        fabric.Image.fromURL(dataUrl, function(img) {
            img.set({
                left: activeObject.left - (offsetX * activeObject.scaleX),
                top: activeObject.top - (offsetY * activeObject.scaleY),
                scaleX: activeObject.scaleX,
                scaleY: activeObject.scaleY,
                angle: activeObject.angle,
                selectable: true,
                evented: true
            });

            canvas.remove(activeObject);
            canvas.add(img);
            canvas.setActiveObject(img);
            canvas.renderAll();
        });

        document.getElementById('outlineModal').style.display = 'none';
    }
});

function updateSliderValues() {
    document.getElementById('sliderValue1').textContent = document.getElementById('outlineSlider1').value + 'px';
    document.getElementById('sliderValue2').textContent = document.getElementById('outlineSlider2').value + 'px';
}

function applyOutlines() {
    const width1 = document.getElementById('outlineSlider1').value;
    const width2 = document.getElementById('outlineSlider2').value;
    const color1 = document.getElementById('colorPicker1').value;
    const color2 = document.getElementById('colorPicker2').value;
    const shadows = [];
    
    if (width1 > 0) {
        shadows.push(
            `drop-shadow(${width1}px 0 0 ${color1})`,
            `drop-shadow(-${width1}px 0 0 ${color1})`,
            `drop-shadow(0 ${width1}px 0 ${color1})`,
            `drop-shadow(0 -${width1}px 0 ${color1})`
        );
    }
    
    if (width2 > 0) {
        shadows.push(
            `drop-shadow(${width2}px 0 0 ${color2})`,
            `drop-shadow(-${width2}px 0 0 ${color2})`,
            `drop-shadow(0 ${width2}px 0 ${color2})`,
            `drop-shadow(0 -${width2}px 0 ${color2})`
        );
    }
    
    document.getElementById('outlineImagePreview').style.filter = shadows.join(' ');
}

updateSliderValues();

// ----------------------------------------- Seção Final Contorno ----------------------------------------------------

document.getElementById('exportPNGBtn').addEventListener('click', function() {
    exportCanvas('png');
});

document.getElementById('exportJPGBtn').addEventListener('click', function() {
    exportCanvas('jpg');
});

document.getElementById('exportPDFBtn').addEventListener('click', function() {
    exportPdf(); 
});


function cmToPoints(cm) {
    return cm * 28.3465;
}



// ---------- Inicio Seção Modal Ferramenta links -------------------------------------------
function openDynamicModal(url) {
    const modal = document.getElementById('dynamicModal');
    const iframe = document.getElementById('dynamicIframe');

    iframe.src = url;
    modal.style.display = 'flex';
}

document.getElementById('closeDynamicModal').addEventListener('click', function () {
    const modal = document.getElementById('dynamicModal');
    modal.style.display = 'none';
});

document.getElementById('calendarBtn').addEventListener('click', function () {
    openDynamicModal('https://nkmplay.github.io/cgf/ferramentas/calend.html');
});

document.getElementById('fontepersonBtn').addEventListener('click', function () {
    openDynamicModal('https://nkmplay.github.io/cgf/ferramentas/fonpers.html');
});
// ---------- Fim Seção Modal Ferramenta links -------------------------------------------

// ---------- Inicio Seção Formas -------------------------------------------
function updateFloatingShapeMenu() {
    const activeObject = canvas.getActiveObject();
    const menu = document.getElementById('floating-shape-menu');

    if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'path' || activeObject.type === 'circle')) {
        const zoom = canvas.getZoom();
        const objRect = activeObject.getBoundingRect();
        const canvasRect = canvas.getElement().getBoundingClientRect();

        let left = canvasRect.left + objRect.left + objRect.width + 10;
        let top = canvasRect.top + objRect.top;

        const menuWidth = 200;
        const menuHeight = 150;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        if (left + menuWidth > windowWidth) {
            left = canvasRect.left + objRect.left - menuWidth - 10;
        }
        if (top + menuHeight > windowHeight) {
            top = windowHeight - menuHeight - 10;
        }

        menu.style.left = `${left}px`;
        menu.style.top = `${top}px`;
        menu.style.display = 'block';

        document.getElementById('shape-color').value = activeObject.fill || '#000000';
        document.getElementById('stroke-width').value = activeObject.strokeWidth || 0;
        document.getElementById('stroke-color').value = activeObject.stroke || '#000000';

        const strokeColorInput = document.getElementById('stroke-color');
        strokeColorInput.disabled = activeObject.strokeWidth <= 0;
    } else {
        menu.style.display = 'none';
    }
}

document.getElementById('shape-color').addEventListener('input', function (e) {
  const activeObject = canvas.getActiveObject();
  if (activeObject) {
    activeObject.set('fill', e.target.value);
    canvas.renderAll();
  }
});

document.getElementById('stroke-width').addEventListener('input', function (e) {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
        const strokeWidth = parseInt(e.target.value);
        activeObject.set({
            strokeWidth: strokeWidth,
            stroke: strokeWidth > 0 ? activeObject.stroke || '#000000' : null
        });

        const strokeColorInput = document.getElementById('stroke-color');
        strokeColorInput.disabled = strokeWidth <= 0;

        canvas.renderAll();
    }
});

document.getElementById('stroke-color').addEventListener('input', function (e) {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.strokeWidth > 0) {
        activeObject.set('stroke', e.target.value);
        canvas.renderAll();
    }
});


canvas.on('selection:created', function () {
  updateFloatingShapeMenu();
  updateSizeInputs();
});

canvas.on('selection:updated', function () {
  updateFloatingShapeMenu();
  updateSizeInputs();
});

canvas.on('selection:cleared', function () {
  document.getElementById('floating-shape-menu').style.display = 'none';
  updateSizeInputs();
});


canvas.on('object:rotating', function (e) {
    const obj = e.target;
    if (obj) {
        obj.setCoords();
        canvas.renderAll();
    }
    updateFloatingShapeMenu();
});

canvas.on('object:moving', function (e) {
    const obj = e.target;
    if (obj) {
        obj.setCoords();
        canvas.renderAll();
    }
    updateFloatingShapeMenu();
});

canvas.on('object:scaling', function (e) {
    const obj = e.target;
    if (obj) {
        obj.setCoords();
        canvas.renderAll();
    }
    updateFloatingShapeMenu();
});



document.getElementById('formaquadradoBtn').addEventListener('click', () => {
    const rect = new fabric.Rect({
        left: canvas.width / 2,
        top: canvas.height / 2,
        width: 100,
        height: 100,
        fill: '#ffffff',
        stroke: '#000000',
        strokeWidth: 1,
        originX: 'center',
        originY: 'center'
    });
    saveState();
    canvas.add(rect);
    canvas.setActiveObject(rect);
});

// ---------- Fim Seção Formas -------------------------------------------


// ---------- Inicio Seção Remover Cor  -------------------------------------------

// Variáveis globais
let isColorRemovalActive = false;
let isTotalColorRemovalActive = false;
let tolerance = 30;

// Abrir modal do slider
function openDetectionLevelModal() {
    const modal = document.getElementById('detectionLevelModal');
    modal.style.display = 'flex';
}

// Fechar modal do slider
function closeDetectionLevelModal() {
    const modal = document.getElementById('detectionLevelModal');
    modal.style.display = 'none';
}

// Atualizar valor do slider
document.getElementById('detection-level').addEventListener('input', function () {
    tolerance = parseInt(this.value);
    document.getElementById('sliderValue').textContent = this.value;
});

// Lógica para o botão "Remover Cor Clique"
document.getElementById('removeCorCliqueBtn').addEventListener('click', function () {
    isColorRemovalActive = !isColorRemovalActive;
    isTotalColorRemovalActive = false;

    if (isColorRemovalActive) {
        openDetectionLevelModal();
        canvas.defaultCursor = 'crosshair';
    } else {
        closeDetectionLevelModal();
        canvas.defaultCursor = 'default';
    }
});

// Lógica para o botão "Remover Cor Total"
document.getElementById('removeCorTotalBtn').addEventListener('click', function () {
    isTotalColorRemovalActive = !isTotalColorRemovalActive;
    isColorRemovalActive = false;

    if (isTotalColorRemovalActive) {
        openDetectionLevelModal();
        canvas.defaultCursor = 'crosshair';
    } else {
        closeDetectionLevelModal();
        canvas.defaultCursor = 'default';
    }
});

// Fechar modal e cancelar remoção ao clicar fora do canvas ou do botão
document.addEventListener('click', function (e) {
    const canvasContainer = document.getElementById('canvas-container');
    const removeCorCliqueBtn = document.getElementById('removeCorCliqueBtn');
    const removeCorTotalBtn = document.getElementById('removeCorTotalBtn');
    const modal = document.getElementById('detectionLevelModal');

    // Verifica se o clique foi fora do canvas, dos botões ou do modal
    if (
        !canvasContainer.contains(e.target) &&
        !removeCorCliqueBtn.contains(e.target) &&
        !removeCorTotalBtn.contains(e.target) &&
        !modal.contains(e.target)
    ) {
        closeDetectionLevelModal();
        isColorRemovalActive = false;
        isTotalColorRemovalActive = false;
        canvas.defaultCursor = 'default';
    }
});

// Lógica para remover cores
canvas.on('mouse:down', function (options) {
    if (isColorRemovalActive || isTotalColorRemovalActive) {
        handleColorRemoval(options);
    }
});

function handleColorRemoval(options) {
    const pointer = canvas.getPointer(options.e);
    const clickedObject = canvas.findTarget(options.e);

    if (clickedObject && clickedObject.type === 'image') {
        // Salva o estado atual antes de remover a cor (excluindo o CloudFolha)
        const objects = canvas.getObjects().filter(obj => obj.id !== 'CloudFolha');
        lastRemovedState = canvas.toJSON(['id']); // Salva o estado sem o CloudFolha
        lastRemovedState.objects = objects.map(obj => obj.toJSON(['id'])); // Filtra os objetos

        const imageElement = clickedObject._element;
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = imageElement.width;
        tempCanvas.height = imageElement.height;
        tempCtx.drawImage(imageElement, 0, 0, imageElement.width, imageElement.height);

        const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        const targetColor = getColorAtPosition(imageData, pointer, clickedObject);

        if (targetColor) {
            if (isTotalColorRemovalActive) {
                removeTotalColor(imageData, targetColor);
            } else {
                removeColorArea(imageData, targetColor, pointer, clickedObject);
            }
            tempCtx.putImageData(imageData, 0, 0);

            fabric.Image.fromURL(tempCanvas.toDataURL(), function (img) {
                img.set({
                    left: clickedObject.left,
                    top: clickedObject.top,
                    scaleX: clickedObject.scaleX,
                    scaleY: clickedObject.scaleY,
                    angle: clickedObject.angle,
                    name: clickedObject.name
                });
                canvas.remove(clickedObject);
                canvas.add(img);
                
                // Garantir que a folha CloudFolha esteja no fundo
                const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');
                if (cloudFolha) {
                    canvas.sendToBack(cloudFolha);
                }

                canvas.renderAll();
                updateLayersList();
            });
        }
    }
}

function getColorAtPosition(imageData, pointer, obj) {
    const x = Math.round((pointer.x - obj.left) / obj.scaleX);
    const y = Math.round((pointer.y - obj.top) / obj.scaleY);
    const index = (y * imageData.width + x) * 4;
    return {
        r: imageData.data[index],
        g: imageData.data[index + 1],
        b: imageData.data[index + 2],
        a: imageData.data[index + 3]
    };
}

function removeTotalColor(imageData, targetColor) {
    for (let i = 0; i < imageData.data.length; i += 4) {
        const r = imageData.data[i];
        const g = imageData.data[i + 1];
        const b = imageData.data[i + 2];

        if (
            Math.abs(r - targetColor.r) <= tolerance &&
            Math.abs(g - targetColor.g) <= tolerance &&
            Math.abs(b - targetColor.b) <= tolerance
        ) {
            imageData.data[i + 3] = 0;
        }
    }
}

function removeColorArea(imageData, targetColor, pointer, obj) {
    const stack = [];
    const startX = Math.round((pointer.x - obj.left) / obj.scaleX);
    const startY = Math.round((pointer.y - obj.top) / obj.scaleY);
    stack.push([startX, startY]);

    while (stack.length > 0) {
        const [x, y] = stack.pop();
        const index = (y * imageData.width + x) * 4;

        if (
            x >= 0 && x < imageData.width &&
            y >= 0 && y < imageData.height &&
            imageData.data[index + 3] !== 0 &&
            Math.abs(imageData.data[index] - targetColor.r) <= tolerance &&
            Math.abs(imageData.data[index + 1] - targetColor.g) <= tolerance &&
            Math.abs(imageData.data[index + 2] - targetColor.b) <= tolerance
        ) {
            imageData.data[index + 3] = 0;
            stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
    }
}
document.getElementById('undoColorRemovalBtn').addEventListener('click', function () {
    if (lastRemovedState) {
        canvas.loadFromJSON(lastRemovedState, function () {
            const cloudFolha = canvas.getObjects().find(obj => obj.id === 'CloudFolha');

            if (cloudFolha) {
                canvas.sendToBack(cloudFolha);
            }

            canvas.renderAll();
            updateLayersList();

            lastRemovedState = null;
        });
    }
});

// ---------- Fim Seção Remover Cor  -------------------------------------------


// ---------- Inicio Seção Brilho Contraste Saturação e Nitidez  -------------------------------------------

let selectedImage = null;

function showImageAdjustModal() {
    const modal = document.getElementById('imageAdjustModal');
    modal.style.display = 'block';
}

function hideImageAdjustModal() {
    const modal = document.getElementById('imageAdjustModal');
    modal.style.display = 'none';
}

function updateSliders(image) {
    const brightnessSlider = document.getElementById('brightnessSlider');
    const contrastSlider = document.getElementById('contrastSlider');
    const saturationSlider = document.getElementById('saturationSlider');
    const sharpnessCheckbox = document.getElementById('sharpnessCheckbox');

    image.brightness = image.brightness || 0;
    image.contrast = image.contrast || 0; 
    image.saturation = image.saturation || 0; 
    image.sharpnessEnabled = image.sharpnessEnabled || false; 

    brightnessSlider.value = image.brightness;
    contrastSlider.value = image.contrast;
    saturationSlider.value = image.saturation;
    sharpnessCheckbox.checked = image.sharpnessEnabled;

    document.getElementById('brightnessValue').textContent = `${brightnessSlider.value}%`;
    document.getElementById('contrastValue').textContent = `${contrastSlider.value}%`;
    document.getElementById('saturationValue').textContent = `${saturationSlider.value}%`;
}

function applyImageFilters(image) {
    const brightness = parseInt(document.getElementById('brightnessSlider').value) / 100; // -1 a 1
    const contrast = parseInt(document.getElementById('contrastSlider').value) / 100; // -1 a 1
    const saturation = parseInt(document.getElementById('saturationSlider').value) / 100; // -1 a 1
    const sharpnessEnabled = document.getElementById('sharpnessCheckbox').checked;

    image.filters = [];

    if (brightness !== 0) {
        image.filters.push(new fabric.Image.filters.Brightness({ brightness: brightness }));
    }

    if (contrast !== 0) {
        image.filters.push(new fabric.Image.filters.Contrast({ contrast: contrast }));
    }

    if (saturation !== 0) {
        image.filters.push(new fabric.Image.filters.Saturation({ saturation: saturation }));
    }

    if (sharpnessEnabled) {
        const sharpenMatrix = [
            0, -1, 0,
            -1, 5, -1,
            0, -1, 0
        ];
        image.filters.push(new fabric.Image.filters.Convolute({
            matrix: sharpenMatrix,
            opacity: 1 
        }));
    }

    image.applyFilters();
    canvas.renderAll();
}

document.getElementById('filtroscorBtn').addEventListener('click', () => {
    const activeObject = canvas.getActiveObject();
    if (activeObject && activeObject.type === 'image') {
        selectedImage = activeObject;
        updateSliders(selectedImage);
        showImageAdjustModal();
    } else {
        showCustomAlert('Selecione uma imagem para ajustar Brilho, Contraste e Saturação.');
    }
});

document.getElementById('brightnessSlider').addEventListener('input', (e) => {
    if (selectedImage) {
        document.getElementById('brightnessValue').textContent = `${e.target.value}%`;
        applyImageFilters(selectedImage);
    }
});

document.getElementById('contrastSlider').addEventListener('input', (e) => {
    if (selectedImage) {
        document.getElementById('contrastValue').textContent = `${e.target.value}%`;
        applyImageFilters(selectedImage);
    }
});

document.getElementById('saturationSlider').addEventListener('input', (e) => {
    if (selectedImage) {
        document.getElementById('saturationValue').textContent = `${e.target.value}%`;
        applyImageFilters(selectedImage);
    }
});

document.getElementById('sharpnessCheckbox').addEventListener('change', (e) => {
    if (selectedImage) {
        selectedImage.sharpnessEnabled = e.target.checked;
        applyImageFilters(selectedImage);
    }
});

canvas.on('selection:cleared', () => {
    selectedImage = null;
    hideImageAdjustModal();
});

canvas.on('selection:created', (e) => {
    if (e.target && e.target.type === 'image') {
        selectedImage = e.target;
        updateSliders(selectedImage);
        showImageAdjustModal();
    }
});

canvas.on('selection:updated', (e) => {
    if (e.target && e.target.type === 'image') {
        selectedImage = e.target;
        updateSliders(selectedImage);
        showImageAdjustModal();
    }
});
// ---------- Fim Seção Brilho Contraste Saturação e Nitidez  -------------------------------------------

</script>
</body>
</html>
